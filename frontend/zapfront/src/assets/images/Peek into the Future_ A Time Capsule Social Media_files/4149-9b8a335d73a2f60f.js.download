"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4149],{69806:function(e,t,i){var n=i(85893),o=i(67294),r=i(73935),a=i(12464),s=i(13433),l=i(9228);t.Z=e=>{let{node:t,dragPosition:i,scaleToPage:d,containerZIndex:c}=e;const[u,p]=(0,o.useState)(null),g=(0,s.l)(l.k6),{x:h,y:f}=i||{x:0,y:0};return(0,o.useEffect)((()=>{const e=[`translate(${h}px, ${f}px)`];d&&e.push(`scale(${g})`);const t=document.createElement("div");return t.style.cssText=`\n      position: absolute;\n      top: 0;\n      left: 0;\n\n      pointer-events: none;\n      transform: ${e.join(" ")};\n\n      ${Number.isInteger(c)?`z-index: ${c};`:""}\n    `,p(t),document.body.appendChild(t),()=>{document.body.removeChild(t)}}),[c,g,d,h,f]),u?(0,r.createPortal)((0,n.jsx)(a.t0,{node:t}),u):null}},43644:function(e,t,i){i.d(t,{Z:function(){return p},z:function(){return n}});var n,o=i(13433),r=i(67294),a=i(4480),s=i(82360),l=i(41350),d=i(60531),c=i(9228),u=i(72988);function p(){const{currentPageRef:e}=(0,l.TR)(),t=(0,a.sJ)(d.cm),i=(0,a.sJ)(d.s5),p=(0,o.l)(c.oG),g=(0,a.sJ)(c.DH),h=(0,a.sJ)(s.rQ),f=(0,a.sJ)(s.sA),m=(0,a.sJ)(s.MJ),v=(0,a.sJ)(s.lk),y=(0,a.sJ)(s.GS),w=(0,u.q3)(),I=(0,u.Oy)(),b=Boolean(t||i||g||p||f||v||m),T=Boolean(m||v||h||f||y),R=Boolean(I),x=Boolean(w||I);(0,r.useEffect)((()=>{var t,i,o,r;null===(t=e.current)||void 0===t||t.classList.toggle(n.SELECTION_DISABLED,b),null===(i=e.current)||void 0===i||i.classList.toggle(n.HIGHLIGHT_DISABLED,R),null===(o=e.current)||void 0===o||o.classList.toggle(n.HIGHLIGHT_FORCE,T),null===(r=e.current)||void 0===r||r.classList.toggle(n.POINTER_DISABLED,x)}),[e,b,R,T,x])}!function(e){e.HIGHLIGHT_FORCE="tile-highlight-force",e.HIGHLIGHT_DISABLED="tile-highlight-disabled",e.SELECTION_DISABLED="tile-selection-disabled",e.POINTER_DISABLED="tile-pointer-disabled"}(n||(n={}))},79227:function(e,t,i){i.d(t,{T3:function(){return Rt},mA:function(){return bt},pu:function(){return It},R6:function(){return et}});var n=i(85893),o=i(13433),r=i(50576),a=i(67294),s=i(4480),l=i(59016),d=i(1922),c=i(64310),u=i(9228),p=i(69146),g=i(35527),h=i(41350),f=i(85361),m=i(64945),v=i(10158),y=i(22755),w=i(73406),I=i(94232),b=i(96989),T=i(66810),R=i(96215),x=i(99364);var P,C=l.vJ`
// A powerful override that can remove the cursor
body, body * {
  cursor: none !important;
  user-select: none !important;
  -webkit-user-select: none !important;
}
`,E=i(15764),S=i(29605);!function(e){e.ACTIVE="active",e.SHOW="show",e.HIDE="hide",e.ALERT="alert",e.ALERT_HIDE="alert hide"}(P||(P={}));const D={[P.ACTIVE]:{opacity:.25,transition:{duration:0}},[P.SHOW]:{opacity:.2,transition:{duration:0}},[P.HIDE]:{opacity:0,transition:{duration:.2}},[P.ALERT]:{opacity:1,transition:{duration:0}},[P.ALERT_HIDE]:{opacity:0,transition:{duration:0}}};var L=i(82360),_=i(72988),A=i(69336);const k=(0,l.ZP)(A.E.div).withConfig({displayName:"Resize.styles__Target",componentId:"sc-b5fece72-0"})`
  display: grid;
  place-items: center;
  position: absolute;

  ${e=>{let{$variant:t}=e;switch(t){case"vertical":return"\n          cursor: ew-resize;\n        ";case"horizontal":return"\n          cursor: ns-resize;\n          height: 100%;\n          width: 100%;\n        ";default:return""}}}
`,M=l.ZP.div.attrs((e=>{const t={borderRadius:e.$pagePadding/2};switch(e.$variant){case"vertical":t.height="56px",t.width="4px";break;case"horizontal":t.width="50%",t.height="4px"}return{style:t}})).withConfig({displayName:"Resize.styles__Handle",componentId:"sc-b5fece72-1"})`
  background: ${e=>{let{theme:t,$alert:i}=e;return i?t.colors.red:t.colors.resizeHandle}};
  // No pointer events because the handle is only visual, and the target is what is dragged
  pointer-events: none;
`,$=l.ZP.div.withConfig({displayName:"Resize.styles__TooltipTarget",componentId:"sc-b5fece72-2"})`
  width: ${e=>{let{pagePadding:t}=e;return 2*t}}px;
  display: flex;
  justify-content: center;
  pointer-events: ${e=>{let{enabled:t}=e;return t?"auto":"none"}};
`;var H=e=>{let{onResizeStart:t,onResize:i,onResizeComplete:o,enabled:r,pagePadding:l,stackedPageRef:d}=e;const c=(0,_.WI)(),[u,p]=(0,a.useState)(!1),{scrollingPageRef:g}=(0,a.useContext)(E.Z),h=(0,s.Zl)(L.lk),{scrollContainerIfNeeded:f,cancelAnyScrolling:m}=(0,S.Z)({delayMs:60}),v=(0,a.useRef)(0),y=(0,a.useRef)(0),w=(0,a.useRef)(0),I=(0,a.useRef)(0),b=(0,a.useRef)(0),T=(0,a.useRef)(i);T.current=i;const R=(0,a.useRef)(o);R.current=o;const x=(0,a.useCallback)((()=>{const e=g.current.scrollHeight;e>b.current&&(b.current=e),d.current&&(d.current.style.height=`${b.current}px`)}),[g,d]),A=(0,a.useCallback)((e=>{x(),f(e);const t=e.pageY-v.current;w.current=t,T.current(w.current+I.current)}),[x,f]),$=(0,a.useCallback)((()=>{x();const e=g.current.scrollTop-y.current;I.current=e,T.current(w.current+I.current)}),[x,g]),H=(0,a.useCallback)((()=>{g.current.removeEventListener("scroll",$),window.removeEventListener("mousemove",A),window.removeEventListener("mouseup",H),m(),R.current(),p(!1),h(!1),w.current=0,I.current=0,b.current=0,d.current&&(d.current.style.height="auto",d.current.style.transition="none")}),[m,A,$,g,h,d]),j=(0,a.useCallback)((e=>{p(!0),h(!0),e.preventDefault(),t(),v.current=e.pageY,y.current=g.current.scrollTop,g.current.addEventListener("scroll",$),window.addEventListener("mousemove",A),window.addEventListener("mouseup",H),f(e)}),[t,g,$,A,H,f,h]);return c?null:(0,n.jsxs)(k,{$variant:"horizontal","data-testid":"row_resize_handle",variants:D,initial:P.HIDE,whileHover:u?P.ACTIVE:P.SHOW,animate:u?P.ACTIVE:P.HIDE,style:{pointerEvents:r?"auto":"none"},onMouseDown:j,children:[(0,n.jsx)(M,{$variant:"horizontal",$pagePadding:l,$alert:!1}),u&&(0,n.jsx)(C,{})]})};const j=l.ZP.div.withConfig({displayName:"HorizontalPageRowGutter__Container",componentId:"sc-cdcf5bc6-0"})`
  position: relative;
  width: 100%;
`;var O=e=>{let{children:t,style:i}=e;return(0,n.jsx)(j,{style:i,children:t})},N=i(67591),z=i(37683),Z=i(70918),U=i(69290),W=i(51521);var V=e=>{let{children:t,as:i,indicatorTargetId:o,style:r={},onDrop:l,dataTestId:d}=e;const c=(0,s.Zl)((0,L.fz)(o)),u=(0,s.Zl)(L.M9),p=(0,a.useCallback)((e=>{e.preventDefault(),c(!0),u(o)}),[o,u,c]),g=(0,a.useCallback)((e=>{e.preventDefault(),c(!0),u(o)}),[o,u,c]),h=(0,a.useCallback)((e=>{e.preventDefault(),c(!1),u(null)}),[u,c]),f=(0,s._8)((e=>{let{snapshot:t}=e;return e=>{if(e.preventDefault(),c(!1),u(null),"function"==typeof l){const i=t.getLoadable(L.LY).getValue();l({e:e,dndData:i})}}}),[c,u,l]);return(0,n.jsx)(i,{"data-testid":d,onMouseEnter:p,onMouseOver:g,onMouseLeave:h,onPointerUp:f,onDragEnter:p,onDragLeave:h,onDragOver:g,onDrop:f,style:r,children:t})};const F=(0,l.ZP)(A.E.div).withConfig({displayName:"DropZoneIndicator__Indicator",componentId:"sc-8b0c86d5-0"})`
  background-color: ${e=>e.theme.colors.contentAccent};
  border-radius: 99px;
  position: absolute;
`,B=(0,l.ZP)(F).withConfig({displayName:"DropZoneIndicator__VerticalIndicator",componentId:"sc-8b0c86d5-1"})`
  width: ${N.cn}px;
  height: 100%;
`,G=(0,l.ZP)(F).withConfig({displayName:"DropZoneIndicator__HorizontalIndicator",componentId:"sc-8b0c86d5-2"})`
  height: ${N.cn}px;
  width: calc(100% - ${N.j}px);
`;var J=e=>{let{indicatorId:t,dataTestId:i,style:o,orientation:r}=e;const a=(0,s.sJ)((0,L.fz)(t));let l;switch(r){case"horizontal":l=G;break;case"vertical":l=B}return(0,n.jsx)(l,{"data-testid":i,style:o,initial:{opacity:0},transition:{duration:.15,type:"tween"},animate:{opacity:a?1:0}})};const Y=l.ZP.div.withConfig({displayName:"RowHorizontalDropZone__Container",componentId:"sc-70533949-0"})`
  position: absolute;
  width: 100%;
`,q=l.ZP.div.withConfig({displayName:"RowHorizontalDropZone__StyledDropZone",componentId:"sc-70533949-1"})`
  position: absolute;
  z-index: ${W.xG};
  left: -${1.5*N.j}px;
`;var K=e=>{let{indicatorId:t,onDrop:i,enabled:o,indicatorStyle:r,dropzoneStyle:a,displayIndicator:s,debugMode:l}=e;return(0,_.q3)()&&o||l?(0,n.jsxs)(Y,{children:[(s||l)&&(0,n.jsx)(J,{style:r,indicatorId:t,dataTestId:"flexitome_row_dropzone_indicator",orientation:"horizontal"}),(0,n.jsx)(V,{as:q,dataTestId:"flexitome_row_dropzone",indicatorTargetId:t,onDrop:i,style:{...a,...l?{background:"rgba(255, 100, 100, 0.7)"}:{}}})]}):null};const X=(0,l.ZP)(A.E.div).withConfig({displayName:"TileDropZoneIndicator__Container",componentId:"sc-13dad201-0"})`
  border-radius: ${e=>{let{radius:t}=e;return t}}px;
  width: 100%;
  height: 100%;
  background-color: ${e=>e.theme.colors.tileDropBackground};
  position: absolute;
  z-index: ${W.K5};
`,Q=l.ZP.div.withConfig({displayName:"TileDropZoneIndicator__Overlay",componentId:"sc-13dad201-1"})`
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: center;
  background-color: ${e=>e.theme.colors.tileDropBackgroundOverlay};
`,ee=l.ZP.div.withConfig({displayName:"TileDropZoneIndicator__Label",componentId:"sc-13dad201-2"})`
  font-size: 17px;
  color: ${e=>e.theme.colors.tileDropText};
`;var te=e=>{let{indicatorId:t,radius:i}=e;const{t:o}=(0,d.$G)(),r=(0,s.sJ)((0,L.fz)(t));return(0,n.jsx)(X,{initial:{opacity:0},transition:{duration:.15,type:"tween"},animate:{opacity:r?1:0},radius:i,children:(0,n.jsx)(Q,{children:(0,n.jsx)(ee,{children:o("tiles.dropToUpload")})})})};const ie=l.ZP.div.withConfig({displayName:"VerticalDropZone__Container",componentId:"sc-40b1e98e-0"})`
  position: relative;
  visibility: ${e=>e.$dragInProgress?"visible":"hidden"};
`,ne=l.ZP.div.withConfig({displayName:"VerticalDropZone__DropZoneContainer",componentId:"sc-40b1e98e-1"})`
  position: absolute;
  left: 0;
  width: 100%;
  // // display: flex;
  // left: -${1.5*N.j}px;
  // width: calc(100% + ${3*N.j}px);
`,oe=l.ZP.div.withConfig({displayName:"VerticalDropZone__StyledDropZone",componentId:"sc-40b1e98e-2"})`
  position: absolute;
`,re=(e,t,i,o,r)=>o?(0,n.jsx)(oe,{"data-testid":"flexitome_tile_dropzone"},e):(0,n.jsx)(V,{as:oe,dataTestId:"flexitome_tile_dropzone",indicatorTargetId:t,onDrop:i,style:{...r}},e);var ae=e=>{let{children:t,tileIds:i,tileIdsSupportingTileDropzone:o,rowCanHoldMoreTiles:r,tomeId:l,pageId:d,rowId:c,rowIdx:u,enabled:p,dropHandler:g,onTileDropHandler:h,disabledDropzones:f,dropzoneContainerStyle:m,debugMode:v,pageWidth:y,pagePadding:w,tileRadius:I}=e;const b=(0,s.sJ)(L.GS),T=(0,s.sJ)(L.sA),R=(0,_.q3)(),x=T&&i.includes(T),{getMainController:P}=(0,a.useContext)(z.Z),C=P(d),E=[],S=[];for(let e=0;e<=i.length;e++){const t=f.includes(e),s=0===e;let p;const b=e===i.length;p=r||!b||x?{tomeId:l,pageId:d,kind:"vertical",rowId:c,tileIdx:e}:{tomeId:l,pageId:d,kind:"horizontal",rowIdx:u+1};const T=i[e]??i[e-1];if(!T)return null;const R=C.getTilePosition(T,y,w),P={...m,...v?{backgroundColor:"rgba(0, 0, 0, 0.2)",border:"1px solid lime"}:{},width:R.width/2+1.5*N.j,left:R.left+R.width/2-w};if(s&&(P.left=1.5*-N.j),!s&&!b){const t=C.getTilePosition(i[e-1],y,w);P.left=t.left+t.width/2-w,P.width=t.width/2+R.width/2+w}if(b&&(P.left=R.left+R.width/2-w),E.push(re(e,p,g({kind:U.rw.EXISTING_ROW,rowId:c,newTileIdx:e}),t,P)),b)break;const L={...v?{backgroundColor:"rgba(255, 255, 0, 0.2)",border:"1px solid yellow"}:{},height:"100%",width:R.width,left:R.left-w,position:"absolute"},_={tomeId:l,pageId:d,kind:"tile",tileId:T};o.has(T)&&S.push((D=`tile_${T}`,A=_,k=h(T),M=L,$=I,(0,n.jsx)(a.Fragment,{children:(0,n.jsx)(V,{as:oe,dataTestId:"flexitome_tile_file_dropzone",indicatorTargetId:A,onDrop:k,style:M,children:(0,n.jsx)(te,{indicatorId:A,radius:$})})},D)))}var D,A,k,M,$;return(0,n.jsxs)(ie,{$dragInProgress:!!R||v,children:[t,p&&(R||v)&&(0,n.jsx)(ne,{style:{height:"100%",top:0},children:E.concat(b?S:[])})]})};const se=l.ZP.div.withConfig({displayName:"VerticalIndicator__Container",componentId:"sc-92b5510-0"})`
  width: 100%;
  height: 100%;
`;var le=e=>{let{debugMode:t,indicatorId:i}=e;const o=(0,_.q3)();return t||o?(0,n.jsx)(se,{children:(0,n.jsx)(J,{indicatorId:i,dataTestId:"flexitome_tile_dropzone_indicator",orientation:"vertical"})}):null};const de=l.ZP.div.withConfig({displayName:"VerticalTileGutter__Container",componentId:"sc-efbe3ae8-0"})`
  position: absolute;
  height: 100%;
  ${e=>e.$debugMode&&"background-color: rgba(0, 0, 255, 0.4);"}
`;var ce=e=>{let{children:t,debugMode:i,style:o}=e;return(0,n.jsx)(de,{$debugMode:i,style:o,children:t})},ue=i(93996),pe=i(33471),ge=i(15135);var he=e=>{let{onResizeStart:t,onResize:i,onResizeComplete:o,pagePadding:r,rowIndex:l,tileIndex:c,tilePosition:u,pageWidth:p}=e;const g=u.left-1.5*r,[h,f]=(0,a.useState)(!1),[m,v]=(0,a.useState)(!1),y=(0,_.WI)(),w=(0,s.sJ)(L.lk),[I,b]=(0,s.FV)(L.MJ),T=!y&&!w&&(!I||h),R=(0,a.useRef)(0),x=(0,a.useRef)(i);x.current=i;const E=(0,a.useRef)(o);E.current=o;const S=(0,a.useCallback)((e=>{const t=e.pageX-R.current,i=x.current(t);v(i===ge.yV.REACHED_MINIMUM)}),[]),A=(0,a.useCallback)((()=>{f(!1),b(!1),v(!1),window.removeEventListener("mousemove",S),window.removeEventListener("mouseup",A),E.current()}),[S,b]),H=(0,a.useCallback)((e=>{f(!0),b(!0),t(e.altKey),R.current=e.pageX,window.addEventListener("mousemove",S),window.addEventListener("mouseup",A)}),[S,A,t,b]),j=u.left<p/2?"right":"left",O=m?P.ALERT:P.ACTIVE,N=m?P.ALERT_HIDE:P.HIDE,{t:z}=(0,d.$G)();return(0,n.jsxs)(k,{"data-testid":"tile_resize_handle","data-testid-resize-position":`${l}-${c}`,$variant:"vertical",style:{top:u.top,height:u.height,left:g,width:2*r,pointerEvents:T?"auto":"none"},variants:D,initial:P.HIDE,whileHover:h?O:P.SHOW,animate:h?O:N,onMouseDown:H,children:[(0,n.jsx)(ue.Z,{content:z("pageLayout.resizeHandles.tileWidthResizeHandle.resizeAdjacentHandle"),shortcuts:[(0,pe.C6)(),"↔"],placement:j,tooltipDisabled:!T,delay:500,offset:8,children:(0,n.jsx)($,{pagePadding:r,enabled:T,"data-testid":"tooltip_target",children:(0,n.jsx)(M,{$variant:"vertical",$pagePadding:r,$alert:h&&m})})}),h&&(0,n.jsx)(C,{})]})};var fe=e=>{let{pageId:t,rowId:i,rowIndex:o,sizes:r,tileId:s,tileIndex:l}=e;const{pageSizes:d}=r,{getMainController:c}=(0,a.useContext)(z.Z),u=c(t),p=u.getTilePosition(s,d.width,d.padding),{handleResizeStart:g,handleResize:h,handleResizeComplete:f}=(0,a.useMemo)((()=>u.getTileResizeHandlers(l,i,d.width)),[u,l,i,d.width]);return(0,n.jsx)(he,{rowIndex:o,tileIndex:l,onResizeStart:g,onResize:h,onResizeComplete:f,tilePosition:p,pagePadding:d.padding,pageWidth:d.width},s)};const me=l.ZP.div.withConfig({displayName:"RowInteractivity__TilesOverlayContainer",componentId:"sc-39f8ffb7-0"})`
  width: 100%;
  ${e=>e.$debugMode&&"background-color: rgba(0, 255, 0, 0.4);"}
`;var ve=e=>{let{pageId:t,tileLookupRef:i,sizes:r,rowLayout:l,rowIdx:P,tomeId:C,rowHeightInUnits:E,isFirstRow:S,isLastRow:D,stackedPageRef:_,debugMode:A=!1}=e;const k=(0,a.useMemo)((()=>new Z.Z(l)),[l]),{t:M}=(0,d.$G)(),{pageSizes:$,rowSizes:j}=r,{exclusiveSelectTiles:W}=(0,T.N4)(),V=(0,o.l)(u.oG),F=(0,s.Zl)((0,v.$)(C)),{apolloClient:B,clientId:G}=(0,h.bp)(),J=(0,s.sJ)(T.py),[Y,q]=(0,s.FV)(L.sA),{getMainController:X}=(0,a.useContext)(z.Z),Q=X(t),ee=(0,y.t2)(),te=(0,a.useCallback)((function(e,i){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(!e.length)return null;const o=(0,x.ln)({tomeId:C,pageId:t,pageController:Q,newTilesData:e,apolloClient:B,clientId:G,insertTileLocation:i});return W(o),n&&ee.setPropertyPanel(w.Z.TILE),o}),[C,t,Q,B,G,W,ee]),{onInsertFiles:ie}=(0,p.Z)({addTilesInPage:te}),ne=(0,s._8)((e=>{let{set:t}=e;return(e,i)=>{var n,o;(null===(n=i)||void 0===n?void 0:n.type)===R.YUT.Image&&!i.contentLink&&e.type.startsWith("image/")&&t((0,I.vw)(i.id),(0,I.aY)(e)),(null===(o=i)||void 0===o?void 0:o.type)===R.YUT.Video&&!i.contentLink&&e.type.startsWith("video/")&&t((0,I.vw)(i.id),(0,I.aY)(e))}}),[]),oe=(0,m.Z)(((e,t)=>{let{e:n}=t;if((0,f.X)(n)&&(0,f.C)(n)&&n.dataTransfer.files.length>0){var o;const t=n.dataTransfer.files[0],r=null===(o=i.current)||void 0===o?void 0:o.get(`${e}`);r&&ne(t,r)}}),[ne,i]),re=(0,m.Z)(((e,t)=>{let{e:n,dndData:o}=t;if((0,f.X)(n)&&(0,f.C)(n)){const t=n.dataTransfer.files,i=[];for(let e=0;e<t.length&&e<16;e++)i.push(t[e]);c.v.addAction("Drag to add media",{files:i.map((e=>({name:e.name,type:e.type})))});const o=ie(i,e);o.length>0&&(F({title:M("pageLayout.unsupportedMediaAlert.title"),subtitle:M("pageLayout.unsupportedMediaAlert.subtitle")}),c.v.addAction("Unsupported media format after dragging",{file:o.map((e=>({name:e.name,type:e.type})))}))}else if(o)switch(o.kind){case g.A.ADD_TILE:te([o.createTileData],e);break;case g.A.MOVE_TILE:{var r;if(q(null),!o.tileIds.length)break;if(!n.altKey||o.tileIds.length>1){Q.moveTiles(Q.getOrderedTileIds(o.tileIds),e);break}const t=null===(r=i.current)||void 0===r?void 0:r.get(o.tileIds[0]);if(t){const i={...t};delete i.id;const n={kind:U.rw.EXISTING_ROW,rowId:k.id,newTileIdx:k.tileIndex(t.id)??0};te([i],n,!1),Q.moveTile(o.tileIds[0],e),requestAnimationFrame((()=>{W([t.id])}))}break}}}),[ie,F,M,te,q,i,Q,k,W]),{handleResizeStart:se,handleResize:de,handleResizeComplete:ue}=(0,a.useMemo)((()=>Q.getRowResizeHandlers(k.id)),[Q,k.id]),pe=e=>({tomeId:C,pageId:t,kind:"horizontal",rowIdx:e}),ge=e=>({tomeId:C,pageId:t,kind:"vertical",rowId:k.id,tileIdx:e}),he=(0,a.useMemo)((()=>Y?Q.findNoopDropzones(Array.from(J)):{vertical:[],horizontal:[]}),[Y,Q,J]),ve=(0,s._8)((e=>{let{snapshot:t}=e;return e=>(!t.getLoadable(b.zh).getValue()||1!==J.size)&&he.horizontal.includes(e)}),[he.horizontal,J.size]),ye=(0,s._8)((e=>{let{snapshot:t}=e;return()=>{if(t.getLoadable(b.zh).getValue()&&1===J.size)return[];const e=he.vertical.find((e=>e.rowIdx===P));return e?e.indices:[]}}),[he.vertical,P,J.size]),we=j.unitRowHeight*E,Ie=we-$.padding,be=we*N.p3,Te=i.current,Re=(0,a.useMemo)((()=>{var e;return new Set([...(null===(e=Te)||void 0===e?void 0:e.values())??[]].filter((e=>!e.contentLink&&(e.type===R.YUT.Image||e.type===R.YUT.Video))).map((e=>e.id)))}),[Te]);return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(K,{enabled:!V&&!ve(P),indicatorId:pe(P),onDrop:re({kind:U.rw.NEW_ROW,newRowIdx:P}),displayIndicator:S,indicatorStyle:{top:S?0:$.padding/2-N.cn/2},dropzoneStyle:{top:S?-N.tS-$.padding/2:-$.padding/2,height:S?N.tS+be:be,width:$.width+2*N.j},debugMode:A}),(0,n.jsx)(ae,{tileIds:k.tiles.map((e=>e.tileId)),tileIdsSupportingTileDropzone:Re,rowCanHoldMoreTiles:k.canAddMoreTiles(),tomeId:C,pageId:t,rowId:k.id,rowIdx:P,enabled:!V,dropHandler:re,onTileDropHandler:oe,disabledDropzones:ye(),dropzoneContainerStyle:{top:be-$.padding/2,height:3*be},debugMode:A,pageWidth:$.width,pagePadding:$.padding,tileRadius:r.tileSizes.radius,children:(0,n.jsx)(me,{$padding:$.padding,$debugMode:A,"data-testid":"page_row",style:{height:`${Ie}px`},children:k.tiles.map(((e,t)=>{const{tileId:i}=e,o=Q.getTilePosition(i,$.width,$.padding),r=o.left+o.width-$.padding/2-N.cn/2,s=o.left+o.width-$.padding;return(0,n.jsxs)(a.Fragment,{children:[0===t&&(0,n.jsx)(ce,{debugMode:A,style:{left:-N.cn},children:(0,n.jsx)(le,{debugMode:A,indicatorId:ge(0)})}),(0,n.jsx)(ce,{debugMode:A,style:{left:t<k.tiles.length-1?r:s},children:(0,n.jsx)(le,{debugMode:A,indicatorId:ge(t+1)})})]},i)}))})}),k.tiles.map(((e,i)=>0===i?null:(0,n.jsx)(fe,{pageId:t,tileIndex:i,rowIndex:P,rowId:k.id,sizes:r,tileId:e.tileId},e.tileId))),(0,n.jsx)(K,{indicatorId:pe(P+1),onDrop:re({kind:U.rw.NEW_ROW,newRowIdx:P+1}),enabled:!ve(P+1),indicatorStyle:{top:$.padding/2-N.cn/2},dropzoneStyle:{bottom:D?-N.tS-$.padding/2:-$.padding/2,height:D?N.tS+be:be,width:$.width+2*N.j},displayIndicator:!0,debugMode:A}),(0,n.jsx)(O,{style:{height:$.padding},children:(0,n.jsx)(H,{onResizeStart:se,onResize:de,onResizeComplete:ue,enabled:!V,pagePadding:$.padding,stackedPageRef:_})})]})},ye=i(60531),we=i(46051),Ie=i(12887),be=i(97808),Te=i(97463);const Re=/--.*[^)]/;var xe=()=>{const e=(0,a.useCallback)(((e,t)=>{var i;return e.getPropertyValue((null===(i=t.match(Re))||void 0===i?void 0:i[0])??t)}),[]);return{getComputedColors:(0,a.useCallback)(((t,i)=>{let n=[];if(t.current){const o=getComputedStyle(t.current);n=i.map((t=>e(o,t)))}return n}),[e])}},Pe=i(10987),Ce=i(16247),Ee=i(9043),Se=i(64364),De=i(37511),Le=i(97712),_e=i(32490),Ae=i(5372);function ke(e){return JSON.parse(JSON.stringify(e))}const Me=new Map,$e=e=>{let{component:t,id:i,children:o,debug:r=!1}=e;return(0,n.jsx)(a.Profiler,{id:`${t}:${i}`,onRender:He(r),children:o})},He=e=>{e&&Ze();return(t,i)=>{if(!e&&!window.Cypress)return;e&&console.log(`Profiler onRender: ${t} ${i}`);const n=ke(Me.get(t)||{count:{mount:0,update:0,nestedUpdate:0,other:0}});switch(i){case"mount":n.count.mount+=1;break;case"update":n.count.update+=1;break;case"nested-update":n.count.nestedUpdate+=1;break;default:n.count.other+=1}Me.set(t,n),e&&console.log("Profiler profiles:",Object.fromEntries(Me.entries()))}},je=e=>void 0===e?Oe():Ne(e),Oe=()=>{return e=Me,new Map(ke(Array.from(e)));var e},Ne=e=>[...Me].filter((t=>{let[i]=t;return i.includes(e)})).reduce(((e,t)=>{let[i,n]=t;return e.set(i,ke(n)),e}),new Map),ze=()=>{Me.clear()},Ze=()=>{void 0===window.getProfiles&&(window.getProfiles=je),void 0===window.resetProfiles&&(window.resetProfiles=ze)};window.Cypress&&(console.log("Attaching profiler to Cypress"),window.Cypress.profiler={getProfiles:je,resetProfiles:ze});var Ue=i(16834),We=i(28773),Ve=i(17051),Fe=i(18428),Be=i(38176),Ge=i(99949),Je=i(64187);var Ye=i(65745),qe=i(79249),Ke=i(88689),Xe=i(13542),Qe=i(43644);const et=(0,l.ZP)(A.E.div).withConfig({displayName:"Page.styles__PageStyles",componentId:"sc-1aa9c2ee-0"})`
  height: 100%;

  position: relative;
  justify-content: start;
  align-items: center;

  @media ${qe.Hb.mobile} {
    display: flex;
    flex-direction: column;
  }

  visibility: ${e=>e.$preview||e.$isVisible?"visible":"hidden"};

  /**
  * GlobalTileSelectionState are classnames that can be toggled in useGlobalTileSelectionState.
  * These can be used to change styles on large groups of elements without needing to re-render all of them.
  */

  // Highlight all tiles during a layout operation to show better the tile bounds to users.
  &.${Qe.z.HIGHLIGHT_FORCE} ${Ye.y$} {
    opacity: 1;
  }

  // Disable all highlighting.
  &.${Qe.z.HIGHLIGHT_DISABLED} ${Ye.y$} {
    opacity: 0;
  }

  // Disable all selection rings.
  &.${Qe.z.SELECTION_DISABLED} ${Ye.Y1} {
    opacity: 0;
  }

  &.${Qe.z.SELECTION_DISABLED}
    ${Xe.Y} {
    opacity: 0;
  }

  // Disable pointer events on the tile
  &.${Qe.z.POINTER_DISABLED} {
    ${Ke.cq} {
      pointer-events: none;
    }
  }
`;var tt=i(7056),it=i(60153),nt=i(12464),ot=i(24389),rt=i(69806);var at=l.vJ`
// A powerful override that is only present when dragging to copy
body, body * {
  cursor: copy !important;
  user-select: none !important;
}
`;const st="tile-last-dragged-item",lt=(0,l.ZP)(A.E.div).withConfig({displayName:"TilePositioner__AnimatedWrapper",componentId:"sc-bbc92786-0"})`
  position: absolute;

  &.${st} {
    /* pointer-events: none is necessary to prevent a click on the tile during
     * an animation from interrupting the animation and sticking it in place.
     * See https://linear.app/tome/issue/WEB-1968/safari-only-stuck-position-of-image-tile-after-dragging
     * for more information. */
    pointer-events: none !important;
    z-index: 1 !important;
  }
`,dt={type:"spring",stiffness:110,damping:20,mass:1},ct={backgroundColor:"unset",boxShadow:"unset",transformOrigin:"0px 0px",pointerEvents:"auto"},ut={scale:.75,zIndex:W.C8,pointerEvents:"none"},pt=()=>{},gt=(0,a.memo)((e=>{let{dataTestIdTilePosition:t,children:i,position:o,isPreview:r,enableDrag:s,animatingBorderRadius:l,style:d,dragControls:c,draggableTileRef:u,isTileDragging:p=!1,isPartOfDragGroup:g=!1,animationStyle:h=ct,dragStartPosition:f,handleMouseDown:m=pt,onDrag:v=pt,onDragStart:y=pt,onDragEnd:w=pt,onAnimationStart:I=pt,onAnimationComplete:b=pt,onDragTransitionEnd:T=pt,showShadowTile:R=!1}=e;const x=(0,a.useMemo)((()=>(0,nt.oD)()),[]),P=(0,a.useMemo)((()=>({rest:{...o,transition:{duration:0}},active:{borderRadius:l,...o,transition:r?{duration:0}:{...dt,duration:.3}}})),[o,l,r]),C=(0,a.useMemo)((()=>({...h,...d,backgroundColor:"transparent"})),[h,d]);return x?(0,n.jsxs)("div",{suppressHydrationWarning:!0,children:[R&&(0,n.jsx)(lt,{initial:o,style:d,children:i}),(0,n.jsx)(nt.Nq,{node:x,children:(r||!g||p)&&(0,n.jsx)(lt,{"data-testid":"tile_positioner","data-testid-tile-position":t,ref:u,variants:P,initial:"rest",animate:p&&!r?"active":"rest",drag:s,dragControls:c,dragSnapToOrigin:!0,onPointerDown:m,onDragStart:y,onDrag:v,onDragEnd:w,onAnimationStart:I,onAnimationComplete:b,onDragTransitionEnd:T,style:C,suppressHydrationWarning:!0,whileDrag:ut,children:i})}),!r&&p?(0,n.jsx)(rt.Z,{scaleToPage:!0,dragPosition:f,node:x}):(0,n.jsx)(nt.t0,{node:x}),p&&!R&&(0,n.jsx)(ot.Z,{}),R&&(0,n.jsx)(at,{})]}):(0,n.jsx)("div",{children:(0,n.jsx)(lt,{initial:o,style:h,children:i})})})),ht=(0,a.memo)((e=>{let{dataTestIdTilePosition:t,children:i,position:o,tileId:r,enableDrag:d,pageVerticalMargin:c,setTileIsAnimating:p,animatingBorderRadius:h,style:f}=e;const m=(0,it.o)(),v=(0,a.useRef)(null),{scrollContainerIfNeeded:y,cancelAnyScrolling:w}=(0,S.Z)(),I=(0,s.sJ)((0,T.j6)({tileId:r})),R=(0,s.sJ)(L.sA),x=R===r,P=I&&null!==R,[C,D]=(0,a.useState)({x:0,y:0}),[_,A]=(0,a.useState)(),{scrollingPageRef:k}=(0,a.useContext)(E.Z),M=(0,l.Fg)(),$=(0,s.Zl)(L.LY),H=(0,a.useCallback)((e=>{const t=e.target,i=null!==t.closest("[data-disable-drag]"),n=null!==t.closest("[data-slate-editor]");(i||n)&&m.componentControls.forEach((t=>{t.stop(e)}))}),[m]),j=(0,a.useCallback)((e=>{y(e)}),[y]),O=(0,s._8)((e=>{let{snapshot:t,set:i}=e;return e=>{if(v.current){var n,o,a;const t=v.current.getBoundingClientRect();D({x:e.pageX-t.x,y:e.pageY-t.y});const i=null===(n=v.current.offsetParent)||void 0===n?void 0:n.getBoundingClientRect();var s,l;if((null===(o=i)||void 0===o?void 0:o.x)&&(null===(a=i)||void 0===a?void 0:a.y))A({x:null===(s=i)||void 0===s?void 0:s.x,y:null===(l=i)||void 0===l?void 0:l.y})}I||i(T.py,new Set([r])),i(L.sA,r);const d=t.getLoadable(T.py).getValue(),c={kind:g.A.MOVE_TILE,tileIds:I?Array.from(d):[r]};$(c)}}),[I,$,r]),N=(0,a.useRef)(!1),z=(0,s._8)((e=>{let{set:t}=e;return()=>{var e;w(),D({x:0,y:0}),t(L.sA,null),N.current=!0,p(r,!0),null===(e=v.current)||void 0===e||e.classList.add(st)}}),[w,p,r]),Z=(0,a.useRef)(!1),U=(0,a.useCallback)((()=>{if(!N.current&&!Z.current){0===p(r,!1)&&document.querySelectorAll(`.${st}`).forEach((e=>{e.classList.remove(st)}))}}),[p,r]),W=(0,a.useCallback)((e=>{"rest"===e&&(p(r,!0),Z.current=!0)}),[p,r]),V=(0,a.useCallback)((e=>{"rest"===e&&(Z.current=!1,U())}),[U]),F=(0,a.useCallback)((()=>{N.current=!1,U()}),[U]),[B,G]=(0,s.FV)((0,u.Eq)(r)),J=(0,a.useCallback)((()=>{if(k.current){const e=k.current,t=e.scrollTop+e.clientHeight-M.headerHeight-c,i=o.top+o.height;i>=t?e.scrollTop+=i-t:o.top<e.scrollTop&&(e.scrollTop=o.top)}}),[o.height,o.top,c,k,M.headerHeight]);(0,a.useEffect)((()=>{B&&(J(),G(!1))}),[J,B,G]);const Y=(0,s._8)((e=>{let{snapshot:t}=e;return()=>{const e=t.getLoadable(b.zh).getValue(),i=t.getLoadable(T.T0).getValue();return x&&e&&!i}}),[x]),q=Y(),K=(0,a.useMemo)((()=>({backgroundColor:x?M.colors.tilePositionWhileDragBackground:"unset",boxShadow:x?M.colors.tilePositionAnimatingShadow:"unset",transformOrigin:`${C.x}px ${C.y}px`,pointerEvents:"auto"})),[x,M.colors.tilePositionWhileDragBackground,M.colors.tilePositionAnimatingShadow,C.x,C.y]);return(0,n.jsx)(gt,{dataTestIdTilePosition:t,position:o,isPreview:!1,enableDrag:d,animatingBorderRadius:h,style:f,dragControls:m,animationStyle:K,draggableTileRef:v,isTileDragging:x,isPartOfDragGroup:P,dragStartPosition:_,handleMouseDown:H,onDrag:j,onDragStart:O,onDragEnd:z,onAnimationStart:W,onAnimationComplete:V,onDragTransitionEnd:F,showShadowTile:q,children:i})}));var ft=(0,a.memo)((e=>{let{dataTestIdTilePosition:t,children:i,position:o,tileId:r,preview:s,enableDrag:l,pageVerticalMargin:d,setTileIsAnimating:c,animatingBorderRadius:u,style:p}=e;const g=(0,a.useMemo)((()=>{const e={...o};for(const t of Object.keys(e))Number.isNaN(e[t])&&delete e[t];return e}),[o]);return s?(0,n.jsx)(gt,{dataTestIdTilePosition:t,position:g,isPreview:!0,enableDrag:l,animatingBorderRadius:u,style:p,children:i}):(0,n.jsx)(ht,{dataTestIdTilePosition:t,position:g,tileId:r,enableDrag:l,pageVerticalMargin:d,setTileIsAnimating:c,animatingBorderRadius:u,style:p,children:i})}));const mt=(0,a.forwardRef)(((e,t)=>{let{dataTestIdTilePosition:i,tile:o,enableDrag:r,positionTop:s,positionLeft:l,positionWidth:d,positionHeight:c,preview:u,row:p,tomeId:g,sizes:h,pageId:f,pageTheme:m,onTileResize:v,rowHeightinPx:y,canEdit:w,pageVerticalMargin:I,setTileIsAnimating:b,pageKind:T,tilePositionerTransition:R,tilePositionerOpacity:x,clipboardActionsRef:P}=e;const{tileSizes:C}=h,E=(0,a.useMemo)((()=>({...R&&{transition:R},...x&&{opacity:x}})),[R,x]),S=(0,a.useMemo)((()=>({top:s,left:l,width:d,height:c})),[s,l,d,c]);return(0,n.jsx)(ft,{dataTestIdTilePosition:i,position:S,tileId:o.id,preview:u,enableDrag:r,pageVerticalMargin:I,setTileIsAnimating:b,animatingBorderRadius:h.tileSizes.radius,style:E,children:(0,n.jsx)(Ye.ZP,{id:o.id,radius:C.radius,preview:u,canEdit:w,tileType:o.type,children:(0,n.jsx)($e,{component:"Tile",id:o.id,children:(0,n.jsx)(tt.n,{ref:t,canEdit:w,isMobile:!1,preview:u,tile:o,tomeId:g,sizes:h,pageId:f,pageTheme:m,isTileEndpoint:!1,onTileResize:v,rowHeight:y,rowId:p.id,pageKind:T,clipboardActionsRef:P})})},`${o.id}-selection-wrapper`)})}));var vt=(0,a.memo)(mt);const yt=(0,a.memo)((e=>{let{pageId:t,pageTheme:i,isPreview:o,isBot:r=!1,canEdit:l,useEditablePage:d,tomeId:c,sizes:u,pageVerticalMargin:p,pageKind:g,sortedTileRowData:h,tileLookup:f,pageController:m,pageWidth:v,pagePadding:y,enabledDrag:w,expandedTileId:I,triggerLayoutRecalculation:b,isPresentMode:R,clipboardActionsRef:x,isScreenSizeReady:P}=e;const C=(0,s._8)((e=>{let{set:t}=e;return(e,i,n,o)=>{t((0,T.pq)({tileId:e,tileType:i}),{rowIdx:n,tileIdx:o})}}),[]);(0,a.useEffect)((()=>{o||h.forEach((e=>{let{tileId:t,rowIndex:i,tileIndexInRow:n}=e;const o=f.get(t);o&&C(t,o.type,i,n)}))}),[h,C,f,o]);const E=(0,a.useRef)(new Set),S=(0,a.useCallback)(((e,t)=>(t?E.current.add(e):E.current.delete(e),E.current.size)),[E]);return(0,n.jsx)(n.Fragment,{children:h.map((e=>{let{tileId:a,row:s,rowIndex:h,tileIndexInRow:T}=e;const C=f.get(a);if(!C)return null;const E=m.getTilePositionFromRow(a,s,v,y);if(!d&&g===Ie.sb.OUTLINE&&we.XW<E.top)return null;const D=m.getTileHeightInPx(s.id),L=r||P?1:0,_=!d&&R&&!o;return I&&I!==a?(0,n.jsx)("div",{},C.id):(0,n.jsx)(vt,{dataTestIdTilePosition:`${h}-${T}`,tilePositionerTransition:_?"opacity 0.5s cubic-bezier(0.33, 1, 0.68, 1)":void 0,tilePositionerOpacity:_?L:void 0,ref:m.tileRefCallback(a),tile:C,preview:o,positionTop:E.top,positionLeft:E.left,positionWidth:E.width,positionHeight:E.height,enableDrag:w,row:s,tomeId:c,sizes:u,pageId:t,pageTheme:i,onTileResize:b,rowHeightinPx:D,canEdit:l,pageVerticalMargin:p,setTileIsAnimating:S,pageKind:g,clipboardActionsRef:x},C.id)}))})})),wt=l.ZP.div.withConfig({displayName:"Page__StackedPage",componentId:"sc-30647c50-0"})`
  position: relative;
  display: flex;
  justify-content: center;
`,It=l.ZP.div.withConfig({displayName:"Page__PageSelectionRing",componentId:"sc-30647c50-1"})``,bt=l.ZP.div.withConfig({displayName:"Page__PagePreviewWrapper",componentId:"sc-30647c50-2"})``,Tt=(e,t)=>{let{pageId:i,pageTiles:c,pageLayout:g,pageTheme:f,pageOverlay:m,preview:v,isActive:w,isBot:b=!1,isVisible:P,canEdit:C,useEditablePage:E,tomeId:S,sizes:D,pageVerticalMargin:L,pageKind:A,debugMode:k=!1,skipReportPresence:M=!1}=e;var $;const{t:H}=(0,d.$G)(),{apolloClient:j,clientId:O}=(0,h.bp)(),N=(0,s.sJ)(ye.cm),z=(0,s.sJ)(ye.s5),Z=(0,o.l)(u.oG),W=(0,s.sJ)(u.DH),{deselectTile:V}=(0,T.N4)(),F=(0,s.sJ)(Ae.t),B=(0,s.sJ)((0,Pe.J)(S)),G=(0,l.Fg)(),J=(0,a.useRef)(null),{pageSizes:Y,rowSizes:q}=D,K=(0,_.Oy)(),X=(0,a.useCallback)((()=>{be.z.reportViewPresence(j,O,S,i)}),[j,O,S,i]);(0,a.useEffect)((()=>{M||!v&&w&&X()}),[w,v,X,M]);const Q=(0,Se.Z)(c),ee=(0,s._8)((e=>{let{snapshot:t}=e;return async()=>{var e,i;if(!w||v)return;const n=t.getLoadable(T.py).getValue(),o=new Set,r=null===(e=Q)||void 0===e?void 0:e.map((e=>e.id)),a=null===(i=c)||void 0===i?void 0:i.map((e=>e.id));n.forEach((e=>{var t;(null===(t=r)||void 0===t?void 0:t.includes(e))&&o.add(e)})),new Set(o).forEach((e=>{var t;(null===(t=a)||void 0===t?void 0:t.includes(e))&&o.delete(e)}));for(const[,e]of o.entries())V(e)}}),[w,V,c,Q,v]);(0,a.useEffect)((()=>{ee()}),[null===($=c)||void 0===$?void 0:$.length]);const te=Z&&!v&&w,{getComputedColors:ie}=xe();(0,Ce.L)(f),(0,a.useInsertionEffect)((()=>{if(!w)return;let e=G.colors.background;te&&(e=G.colors.page);const[t]=ie(J,[e]);t&&(0,Te.A)(t)}),[w,ie,te,G.colors.background,G.colors.page]);const ne=[{type:"option",text:H("hooks.tile.menu.paste"),action:()=>{window.postMessage({type:Ee.SG,dataTransferType:Ee.T0.TILES},"*")}}],oe=(0,We.Z)({tomeId:S,pageId:i,pageKind:A,layout:g,tiles:c,pixelsPerHeightUnit:q.unitRowHeight,rowPadding:Y.padding,persistToBackend:!v}),re=oe.frontendPageLayout,ae=(0,a.useMemo)((()=>oe.triggerLayoutRecalculationAndRender.bind(oe)),[oe]),se=(v||w)&&!K;(0,_e.G)((()=>{se&&ae()}),[se,ae]);const le=oe.sumOfRowHeightsInUnits(),de=(0,Se.Z)(le),ce=D.calculatePageHeight(le),ue=A===Ie.sb.OUTLINE?Math.min(we.XW,ce):ce,pe=(0,a.useRef)(new Map);(0,a.useMemo)((()=>{const e=new Map;if(Array.isArray(c))for(const t of c)e.set(t.id,t);pe.current=e}),[c]);const ge=W&&pe.current.has(W)&&A!==Ie.sb.OUTLINE?W:null,he=function(e){let{pageId:t,tileLookupRef:i,pageController:n,tomeId:o,isPageActive:r,preview:l,canEdit:d}=e;const{apolloClient:c,clientId:g}=(0,h.bp)(),f=(0,y.t2)(),{deleteTilesAction:m}=(0,Ge.Z)(),{exclusiveSelectTiles:v}=(0,T.N4)(),w=r&&d&&!l,b=(0,a.useCallback)((e=>{var t,o;return null===(o=1===e.size?[e.values().next().value]:null===(t=n)||void 0===t?void 0:t.getOrderedTileIds(e))||void 0===o?void 0:o.map((e=>{var t;return null===(t=i.current)||void 0===t?void 0:t.get(e)})).filter((e=>void 0!==e))}),[n,i]),P=(0,a.useCallback)((e=>e.map((e=>{var t,n;if(e.type!==R.YUT.Composite){const t={...e};return delete t.id,t}return null===(n=e.compositeTileData)||void 0===n||null===(t=n.tileIds)||void 0===t?void 0:t.map((e=>{var t;const n=null===(t=i.current)||void 0===t?void 0:t.get(e);if(!n)return;const o={...n};return delete o.id,o})).filter((e=>void 0!==e))})).filter((e=>void 0!==e))),[i]),C=(0,s._8)((e=>{let{snapshot:i}=e;return e=>{if((0,Be.Z)(e))return null;const r=i.getLoadable(T.py).getValue(),a=b(r);return t&&n?(m(a.map((e=>e.id)),t,n,f,o,c,g,!1),P(a)):[]}}),[b,t,n,m,f,o,c,g,P]),E=(0,s._8)((e=>{let{snapshot:t}=e;return e=>{if((0,Be.Z)(e))return null;const i=t.getLoadable(T.py).getValue(),n=b(i);return P(n)}}),[b,P]),S=(0,s._8)((e=>{let{set:i}=e;return(e,r)=>{if(!e.length||!t||!n)return null;const a=(0,x.ln)({tomeId:o,pageId:t,pageController:n,newTilesData:e,apolloClient:c,clientId:g,insertTileLocation:r});return v(a),i((0,u.Eq)(a[0]),!0),a}}),[t,n,o,c,g,v]),{onInsertFiles:D}=(0,p.Z)({addTilesInPage:S}),L=(0,s._8)((e=>{let{snapshot:i}=e;return e=>{var o,r;if(!t||!n)return;const a=i.getLoadable(T.py).getValue(),s=n.getRowAndIndexOfLastTile(Array.from(a));let l={kind:U.rw.END};i.getLoadable(T.$y).getValue()&&void 0!==(null===(o=s)||void 0===o?void 0:o.rowId)&&void 0!==(null===(r=s)||void 0===r?void 0:r.index)&&(l={kind:U.rw.EXISTING_ROW,rowId:s.rowId,newTileIdx:s.index+1}),S(e,l)}}),[S,n,t]),_=(0,s._8)((e=>{let{snapshot:r,set:a}=e;return e=>{var s;const l=r.getLoadable(T.py).getValue();if(1!==l.size)return;const d=Array.from(l)[0],p=null===(s=i.current)||void 0===s?void 0:s.get(d);if(!(p&&t&&n&&e.length))return;const h=(0,Je.Z)(p.id,e[0],t,n,o,c,g);v([h]),a((0,u.Eq)(h),!0)}}),[i,t,n,o,c,g,v]),A=(0,a.useCallback)((function(e,t){if((arguments.length>2&&void 0!==arguments[2]?arguments[2]:{}).isReplace){const e=t.filter((e=>!Array.isArray(e)));_(e)}else L(t)}),[L,_]),k=(0,s._8)((e=>{let{snapshot:o,set:r}=e;return(e,a)=>{var s,l;if(!t||!n||!a.length)return;const d=o.getLoadable(T.py).getValue();d.forEach((e=>{var t;const n=null===(t=i.current)||void 0===t?void 0:t.get(e);if(n){if(n.type===R.YUT.Image&&!n.contentLink&&a[0].type.startsWith("image/")){const e=a.shift();r((0,I.vw)(n.id),(0,I.aY)(e))}if(n.type===R.YUT.Video&&!n.contentLink&&a[0].type.startsWith("video/")){const e=a.shift();r((0,I.vw)(n.id),(0,I.aY)(e))}}}));const c=n.getRowAndIndexOfLastTile(Array.from(d));let u={kind:U.rw.END};o.getLoadable(T.$y).getValue()&&void 0!==(null===(s=c)||void 0===s?void 0:s.rowId)&&void 0!==(null===(l=c)||void 0===l?void 0:l.index)&&(u={kind:U.rw.EXISTING_ROW,rowId:c.rowId,newTileIdx:c.index+1}),D(a,u)}}),[D,n,t,i]),M=(0,s._8)((e=>{let{snapshot:t}=e;return()=>{const e=t.getLoadable(T.py).getValue(),i=b(e),n=P(i);L(n)}}),[b,L,P]),{performCutAction:$,performCopyAction:H,performPasteAction:j}=(0,Ee.ZP)({dataTransferType:Ee.T0.TILES,handleCut:C,handleCopy:E,handlePaste:A,handleFilePaste:k,disabled:!w});return(0,a.useMemo)((()=>({performCutAction:$,performCopyAction:H,performPasteAction:j,performDuplicateAction:M})),[$,H,j,M])}({pageId:i,tileLookupRef:pe,pageController:oe,tomeId:S,isPageActive:w,preview:v,canEdit:C}),fe=(0,a.useRef)(he);fe.current=he;const me=re.sortedTileRowData,Re=(0,a.useRef)(me);if(de!==le)Re.current=me;else if(Re.current.length===me.length)for(let e=0;e<me.length;e+=1){const t=me[e].tileId,i=me[e].row.id,n=oe.getTileRelativeWidth(t),o=oe.getRowRelativeHeight(i);if(me[e].tileRelativeWidth=n??me[e].tileRelativeWidth,me[e].tileRelativeHeight=o??me[e].tileRelativeHeight,!(0,r.Z)(Re.current[e],me[e])){Re.current=me;break}}else Re.current=me;const ke=re.rowLayouts,Me=!v&&C&&!Z&&!ge&&!N&&!z,He=(0,De.Z)(ue),je=()=>{const e={height:`${ue}px`,minHeight:Y.height,width:Y.width,borderRadius:v?0:Y.radius,padding:`${Y.padding}px ${Y.padding}px 0`,backgroundColor:v||!ge||Z?G.colors.page:G.colors.background},o={...e,height:Y.height,overflow:"clip",borderRadius:`${we.tw.radius}px`},r=A===Ie.sb.COMMAND_PROMPT_PREVIEW?o:e;return(0,n.jsxs)(et,{ref:t,...w?{"data-testid":"active_page",id:"active_page"}:{},$isVisible:P,$preview:v,style:r,children:[(0,n.jsx)(yt,{pageId:i,pageTheme:f,isPreview:v,clipboardActionsRef:fe,isBot:b,canEdit:C,useEditablePage:E,tomeId:S,sizes:D,pageVerticalMargin:L,pageKind:A,sortedTileRowData:Re.current,tileLookup:pe.current,pageController:oe,pageWidth:Y.width,pagePadding:Y.padding,enabledDrag:Me,expandedTileId:ge,triggerLayoutRecalculation:ae,isPresentMode:Z,isScreenSizeReady:He}),E&&!v&&w&&!ge&&C&&!K&&ke.map(((e,t)=>(0,n.jsx)($e,{component:"RowInteractivity",id:i,children:(0,n.jsx)(ve,{pageId:i,tileLookupRef:pe,sizes:D,rowLayout:e,rowIdx:t,tomeId:S,rowHeightInUnits:oe.getRowHeight(e.rowId),isFirstRow:0===t,isLastRow:t===ke.length-1,debugMode:k,stackedPageRef:J},e.rowId)},`RowInteractivity:${e.rowId}`)))]})};return(0,n.jsxs)(Fe.Z,{menuWidth:180,menuPosition:"below",menuAlign:"click",rightClickActivated:!0,itemsOrFn:ne,disabled:!C||Z||v,triggerRef:null,children:[w&&(0,n.jsx)(Le.Z,{frontendPageLayout:re,tiles:c}),(0,n.jsx)($e,{component:"Page:"+(v?"outline":"tome"),id:i,children:(0,n.jsxs)(wt,{ref:J,children:[!v&&w&&!B&&(0,n.jsx)(Ue.Z,{overlayData:m,pageId:i,canEdit:C,tomeId:S,display:F,pageHeight:ue,pageWidth:Y.width,isMobile:!1,playMode:Z&&A!==Ie.sb.PAGE_ENDPOINT}),v?(0,n.jsx)(It,{"data-testid":"outline_selection_ring",children:(0,n.jsx)(bt,{children:(0,n.jsx)(Ve.Z,{theme:f,children:je()})})}):(0,n.jsx)(n.Fragment,{children:je()})]})})]})};var Rt=(0,a.memo)((0,a.forwardRef)(Tt))},16834:function(e,t,i){i.d(t,{Z:function(){return se}});var n=i(85893),o=i(67294),r=i(4480),a=i(25675),s=i(4960),l=i(1922),d=i(13847),c=i(9965),u=i(51521),p=i(96215),g=i(41350),h=i(18428),f=i(94232),m=i(58421),v=i(73406),y=i(22755),w=i(24389),I=i(87258),b=i(62830),T=i.n(b),R=i(59016),x=i(64310),P=i(36512),C=i(57602),E=i(1759),S=i(9228),D=i(64364),L=i(26634),_=i(67782),A=i(61098);function k(e,t,i,n){const o=Math.min(e,t);let r=0,a=0;return e>o&&(r=(e-o)/2),t>o&&(a=(t-o)/2),[r,a,o,o,0,0,i,n]}const M=R.ZP.div.withConfig({displayName:"PreviewOverlay__Placeholder",componentId:"sc-33c01ff2-0"})`
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  min-height: 100%;
  min-width: 100%;
  width: 100%;
  height: 100%;
  object-fit: cover;
  background-color: ${e=>e.theme.colors.overlayPlaceholderBg};
  border-radius: 100px;
`,$=R.ZP.img.withConfig({displayName:"PreviewOverlay__Image",componentId:"sc-33c01ff2-1"})`
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  min-height: 100%;
  min-width: 100%;
  width: 100%;
  height: 100%;
  object-fit: cover;
  background-color: ${e=>e.theme.colors.page};
  border-radius: 100px;
  ${e=>{let{$isFlipped:t}=e;return t&&R.iv`
      transform: translate(-50%, -50%) scaleX(-1);
    `}};
`,H=R.ZP.canvas.withConfig({displayName:"PreviewOverlay__HiddenCanvas",componentId:"sc-33c01ff2-2"})`
  display: none;
`,j=R.ZP.video.withConfig({displayName:"PreviewOverlay__HiddenVideo",componentId:"sc-33c01ff2-3"})`
  display: none;
`;var O=e=>{let{enableVideo:t,enableRecording:i,tomeId:a,pageId:s,setCanPlay:c,setScaledUp:u,checkForMediaDevices:p}=e;var h;const{t:m}=(0,l.$G)(),v=(0,C.Z)({tomeId:a}),{apolloClient:y,clientId:w}=(0,g.bp)(),I=(0,o.useRef)(null),b=(0,o.useRef)(null),R=(0,o.useRef)(0),[O,N]=(0,r.FV)((0,f.vw)(s)),z=(0,r.rb)((0,f.vw)(s)),Z=(0,o.useCallback)((e=>{(0,d.XL)(a,s,e,y,w)}),[a,s,y,w]),U=(0,o.useCallback)((e=>{N((t=>({...t,progress:e})))}),[N]),W=(0,o.useCallback)((()=>{(0,d.Yt)(a,s,y,w)}),[a,s,y,w]),V=(0,o.useCallback)((()=>{(0,d.o1)(a,s,y,w),z(),(0,S.ak)({message:m("overlay.genericError")}),x.v.addError(new Error("Failed to upload overlay"),{tomeId:a,pageId:s})}),[a,s,y,w,z,m]),F=(0,o.useCallback)(((e,t)=>{const i=T()(),n=new File([e],i);N((e=>({...e,inProgress:!0}))),v(n,n.name,"",t,void 0,s,U,W,V,Z)}),[N,v,s,U,W,V,Z]),B=(0,o.useCallback)(((e,t)=>{const i=T()();N({uploadId:i,inProgress:!1,progress:0,localMediaUrl:e}),window.safari?t.arrayBuffer().then((e=>{const t=[{name:"inputVideo.mp4",data:e}],n=new Worker("/ffmpeg-worker-mp4.js",{name:"ffmpegjs"});n.onmessage=o=>{const r=o.data;switch(r.type){case"ready":n.postMessage({type:"run",MEMFS:t,arguments:["-i","inputVideo.mp4","-codec","copy","-bsf:v","h264_mp4toannexb","outputStream.mp4"]},[e]);break;case"stdout":case"stderr":console.log(r.data);break;case"done":{const e=r.data.MEMFS[0];if(e.data&&(e.data=e.data.buffer,"outputStream.mp4"===e.name&&n.postMessage({type:"run",MEMFS:r.data.MEMFS,arguments:["-r","30","-i","outputStream.mp4","-c","copy","outputVideo.mp4"]},[e.data]),"outputVideo.mp4"===e.name)){const t=new Blob([e.data]);F(t,i)}break}}}})):F(t,i)}),[N,F]),{startRecording:G,stopRecording:J,turnVideoOn:Y,turnVideoOff:q,previewStream:K,exportStream:X,checkPermissionsAndUpdateMediaDevices:Q}=(0,P.L)({onStop:B}),ee=(0,r.sJ)(A.fT),te=(0,o.useRef)(null),[ie,ne]=(0,o.useState)(null),[oe,re]=(0,o.useState)(!1),{localMediaUrl:ae}=O,se=(0,o.useRef)(!1),le=b.current,de=null===(h=le)||void 0===h?void 0:h.getContext("2d"),ce=(0,o.useCallback)((()=>{if(R.current=requestAnimationFrame(ce),K&&I.current&&le&&de){const{videoWidth:t,videoHeight:i}=I.current,{width:n,height:o}=le;de.clearRect(0,0,n,o);try{var e;null===(e=de)||void 0===e||e.drawImage(I.current,...k(t,i,n,o))}catch(e){x.v.addError(e,{videoWidth:t,videoHeight:i,width:n,height:o,centeredDrawImageParameters:k(t,i,n,o)})}}}),[le,de,K]);(0,o.useEffect)((()=>{if(b.current&&I.current&&te.current&&K&&le){var e;const t=null===(e=K.getVideoTracks())||void 0===e?void 0:e[0];let i;if(t){const e=t.getSettings(),{width:n,height:o}=e,r=Math.min(n??1/0,o??1/0);le.width=r,le.height=r,e.frameRate&&(i=e.frameRate)}const n=le.captureStream(i);n.addTrack(K.getAudioTracks()[0]),te.current.srcObject=n,X&&K&&(X.current=n),I.current.srcObject=K,I.current.play()}}),[le,X,K]),(0,o.useEffect)((()=>(K&&(R.current=requestAnimationFrame(ce)),()=>{cancelAnimationFrame(R.current)})),[ce,K]),(0,o.useEffect)((()=>{te.current&&!K&&(te.current.srcObject=K)}),[K]),(0,o.useEffect)((()=>{p&&!se.current&&(Q(),se.current=!0)}),[p,Q]),(0,o.useEffect)((()=>(t&&Y(),t||(q(),re(!1)),()=>{q(),re(!1)})),[t,Y,q]);const ue=(0,D.Z)(i);(0,o.useEffect)((()=>{i!==ue&&(i&&te.current?(ne(null),Y().then((()=>{G().then((()=>{te.current&&(0,E.b)(te.current).then((e=>{e&&ne(URL.createObjectURL(e))}))}))}))):"recording"===ee&&(J(),q(),re(!1)))}),[i,ee,J,q,Y,G,ue]),(0,o.useEffect)((()=>{c(!1),re(!1),ae||ne(null)}),[c,ae]);const pe=(0,o.useCallback)((()=>{c(!0),re(!0)}),[c]),ge=(0,r._8)((e=>{let{snapshot:t,reset:i}=e;return()=>{const{inProgress:e,uploadId:n,progress:o}=t.getLoadable((0,f.vw)(s)).getValue();e&&x.v.addAction("Unmount while uploading overlay",{uploadVideo:{pageId:s,uploadId:n,progress:o}}),i((0,f.vw)(s))}}),[s]);return(0,o.useEffect)((()=>ge),[ge]),(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(L.U,{animate:{scale:"recording"===ee&&oe?_.p3:1},onAnimationComplete:e=>{e.scale===_.p3?u(!0):u(!1)},children:[t&&(0,n.jsx)(M,{}),ie&&(0,n.jsx)($,{$isFlipped:!0,src:ie}),(0,n.jsx)(L.Y,{$isFlipped:!0,muted:!0,ref:te,width:500,height:500,autoPlay:!0,onCanPlay:pe,$visible:oe})]}),(0,n.jsx)(H,{ref:b}),(0,n.jsx)(j,{muted:!0,playsInline:!0,ref:I})]})};const N=R.ZP.div.withConfig({displayName:"Countdown__CountdownWrapper",componentId:"sc-f160e9a3-0"})`
  height: 294px;
  width: 294px;
  border-radius: 100%;
  background-color: ${e=>{let{theme:t}=e;return t.colors.narrationCountdownBackground}};
  position: absolute;
  margin-left: auto;
  z-index: ${u.tF};
  left: calc(50% - 147px);
  top: calc(50% - 147px);
  font-size: 126px;
  font-weight: 100;
  color: ${e=>{let{theme:t}=e;return t.colors.red}};
  text-align: center;
  vertical-align: middle;
  line-height: 294px;
  box-shadow: 0px 100px 80px rgba(0, 0, 0, 0.07),
    0px 41.7776px 33.4221px rgba(0, 0, 0, 0.0503198),
    0px 22.3363px 17.869px rgba(0, 0, 0, 0.0417275),
    0px 12.5216px 10.0172px rgba(0, 0, 0, 0.035),
    0px 6.6501px 5.32008px rgba(0, 0, 0, 0.0282725),
    0px 2.76726px 2.21381px rgba(0, 0, 0, 0.0196802);
`;var z=e=>{let{time:t,onCountdownComplete:i,onCountdown:r,initialDelay:a=.15,postDelay:s=.1}=e;const[l,d]=(0,o.useState)(t),c=(0,o.useRef)(l),u=(0,o.useRef)(),p=(0,o.useCallback)((()=>{r(c.current-1),d((e=>e-1))}),[r]);return(0,o.useEffect)((()=>(setTimeout((()=>{r(c.current),u.current=window.setInterval(p,1e3)}),1e3*a),()=>clearInterval(u.current))),[p,a,r]),(0,o.useEffect)((()=>{c.current=l,0===l&&(setTimeout((()=>i()),1e3*s),clearInterval(u.current))}),[l,i,s]),(0,n.jsxs)(N,{"data-testid":"countdown",children:[" ",Math.max(l,1)," "]})};var Z=class{async prepareSoundBuffer(e){return new Promise(((t,i)=>{this.audioCtx.decodeAudioData(e,(e=>{t(e)}),(e=>{i(e)}))}))}async setupSound(e){const t=await fetch(e),i=await t.arrayBuffer(),n=await this.prepareSoundBuffer(i);this.soundBuffers[e]=n,this.prepareBufferSource(e)}playSound(e){var t;null===(t=this.soundBufferSources[e])||void 0===t||t.start(),this.prepareBufferSource(e)}teardown(){this.soundBuffers={},this.soundBufferSources={},this.audioCtx.close()}prepareBufferSource(e){const t=this.audioCtx.createBufferSource();t.buffer=this.soundBuffers[e],t.connect(this.audioCtx.destination),this.soundBufferSources[e]=t}constructor(){this.soundBuffers={},this.soundBufferSources={},window.AudioContext=window.AudioContext||window.webkitAudioContext,this.audioCtx=new window.AudioContext}};const U="/assets/countdown_1.mp3",W="/assets/countdown_2.mp3",V="/assets/countdown_3.mp3";var F=(0,o.forwardRef)(((e,t)=>{const i=(0,o.useRef)(null);return(0,o.useEffect)((()=>(i.current=new Z,i.current.setupSound(U),i.current.setupSound(W),i.current.setupSound(V),()=>{var e;null===(e=i.current)||void 0===e||e.teardown()})),[]),(0,o.useImperativeHandle)(t,(()=>({playSoundOne:()=>{var e;null===(e=i.current)||void 0===e||e.playSound(U)},playSoundTwo:()=>{var e;null===(e=i.current)||void 0===e||e.playSound(W)},playSoundThree:()=>{var e;null===(e=i.current)||void 0===e||e.playSound(V)}}))),null})),B=i(69336);const G=R.ZP.div.withConfig({displayName:"Overlay.styles__OverlayProgressWrapper",componentId:"sc-a1a4f29f-0"})`
  position: absolute;
  top: 0;
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
`,J=R.ZP.div.withConfig({displayName:"Overlay.styles__DragZone",componentId:"sc-a1a4f29f-1"})`
  left: 0;
  bottom: 0;
  right: 0;
  position: absolute;
  ${e=>e.inDrag&&R.iv`
      // move the drag zone up to high level so that it will receive click and block pointer event
      // to underlying page component.
      z-index: ${u.Dl-1};
    `}
`,Y=(0,R.ZP)(B.E.div).withConfig({displayName:"Overlay.styles__Dragger",componentId:"sc-a1a4f29f-2"})`
  position: absolute;
  width: 64px;
  height: 64px;
  right: 0;
  top: 0;
  z-index: ${u.Dl};
  pointer-events: auto; // Re-enable pointer-events only for the interactive component
  display: ${e=>e.$hide?"none":"inherit"};

  &:hover {
    cursor: pointer;
  }
`,q=(0,R.ZP)(B.E.div).withConfig({displayName:"Overlay.styles__DragTarget",componentId:"sc-a1a4f29f-3"})`
  position: absolute;
  width: ${e=>e.size}px;
  height: ${e=>e.size}px;
  border-radius: ${e=>e.size}px;
  background-color: ${e=>e.theme.colors.contentAccent};
  opacity: 0.4;
  z-index: ${u.Dl};
`,K=(0,R.ZP)(q).withConfig({displayName:"Overlay.styles__TargetUL",componentId:"sc-a1a4f29f-4"})`
  top: 0;
  left: 0;
`,X=(0,R.ZP)(q).withConfig({displayName:"Overlay.styles__TargetUR",componentId:"sc-a1a4f29f-5"})`
  top: 0;
  right: 0;
`,Q=((0,R.ZP)(q).withConfig({displayName:"Overlay.styles__TargetBR",componentId:"sc-a1a4f29f-6"})`
  bottom: 0;
  right: 0;
`,(0,R.ZP)(q).withConfig({displayName:"Overlay.styles__TargetBL",componentId:"sc-a1a4f29f-7"})`
  bottom: 0;
  left: 0;
`,(0,R.ZP)(B.E.div).withConfig({displayName:"Overlay.styles__OverlayContainer",componentId:"sc-a1a4f29f-8"})`
  position: absolute;
  top: 0;
  right: 0;
  width: 64px;
  height: 64px;
  background-color: transparent;
  z-index: ${u.Dl};
  display: ${e=>e.$hide?"none":"inherit"};
`),ee=(0,R.ZP)(B.E.div).withConfig({displayName:"Overlay.styles__VisibilityContainer",componentId:"sc-a1a4f29f-9"})`
  visibility: ${e=>e.$visibility?"visible":"hidden"};
  position: absolute;
`,te=R.ZP.div.withConfig({displayName:"Overlay.styles__CountdownScrim",componentId:"sc-a1a4f29f-10"})`
  z-index: 1;
  position: absolute;
  background-color: ${e=>e.theme.colors.countdownScrim};
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
`,ie=R.ZP.div.withConfig({displayName:"Overlay.styles__OverlayLayer",componentId:"sc-a1a4f29f-11"})`
  position: ${e=>e.$isMobile?"sticky":"absolute"};
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 999;
  pointer-events: none; // Disable pointer events so other interactions are not blocked, specifically touching on the AV overlay in mobile safari
`,ne=R.ZP.div.withConfig({displayName:"Overlay.styles__StickyWrapper",componentId:"sc-a1a4f29f-12"})`
  position: sticky;
  top: 0;
  // height has to be overlay size (64) + top padding (12) to prevent the wrong vertical position of the overlay when resizing the window.
  height: 76px;
  overflow: visible;
  pointer-events: none; // Disable pointer events so other interactions are not blocked, specifically touching on the AV overlay in mobile safari
`,oe=(e,t)=>[-e+t+12,-12,12];var re;!function(e){e.DEFAULT="default",e.HIDDEN="hidden",e.DRAGGING="dragging",e.CLICKED="clicked"}(re||(re={}));const ae=e=>{let{overlayData:t,pageId:i,tomeId:b,canEdit:T,display:R,pageHeight:x,pageWidth:P,isMobile:C,playMode:E}=e;const{t:S}=(0,l.$G)(),D=(0,r.sJ)(A.wo),{apolloClient:L,clientId:k}=(0,g.bp)(),M=(0,r.sJ)((0,f.vw)(i)),$=(0,r.rb)((0,f.vw)(i)),{localMediaUrl:H}=M,j=(0,y.f3)()===v.Z.RECORD,N=j||D,Z=(0,o.useRef)(null),U=!!H||t.videoStatus===p.Kwn.Ready,[W,V]=(0,o.useState)(!1),[B,q]=(0,o.useState)(!1),[ae,se]=(0,o.useState)(!1),[le,de]=(0,o.useState)(!1),[ce,ue]=(0,o.useState)(!1),pe=(0,o.useRef)(),ge=!N&&!U,[he,fe]=(0,o.useState)(re.DEFAULT),[me,ve]=(0,o.useState)(!1),ye=(0,o.useRef)(!1),we=(0,a._)(),Ie=(0,o.useRef)(null),be=(0,s.c)(0),Te=(0,s.c)(0),[Re,xe]=(0,o.useState)(t.position||p._zJ.UpperRight),Pe=M.inProgress;(0,o.useEffect)((()=>{t.position&&xe(t.position)}),[t.position]),(0,o.useEffect)((()=>{R&&he===re.HIDDEN&&fe(re.DEFAULT),R||fe(re.HIDDEN)}),[R,he]);const Ce=(0,o.useCallback)((()=>{if(Ie.current&&t.position){const e=oe(P,64),[i,n]=((e,t)=>{const[,i]=e.toString().split("_"),n=t[2];let o;return o="LEFT"===i?t[0]:t[1],[o,n]})(t.position,e);be.set(i),Te.set(n)}}),[t.position,P,64,be,Te]);(0,o.useEffect)((()=>{Ce()}),[Ce]),(0,o.useEffect)((()=>{D&&W?(ue(!1),de(!0)):D||(ue(!1),de(!1))}),[D,W]),(0,o.useEffect)((()=>{var e,t;D&&((null===(e=Z.current)||void 0===e?void 0:e.isPlaying())&&(null===(t=Z.current)||void 0===t||t.toggleVideo()))}),[D]),(0,o.useEffect)((()=>{t.videoStatus===p.Kwn.Ready&&$()}),[t.videoStatus,$]);const Ee=(0,o.useCallback)(((e,t)=>{if(fe(re.DEFAULT),Ie.current){const[e,n,o]=oe(P,64),r=e/2,a=1500;let s,l;be.get()<r?(s=e,l="LEFT",t.velocity.x>a&&(s=n,l="RIGHT")):(s=n,l="RIGHT",t.velocity.x<-a&&(s=e,l="LEFT"));const c=o,u=`${"UPPER"}_${l}`;u!==Re&&(xe(u),T&&!C&&(0,d.I2)(b,i,L,k,u)),we.start({x:s,y:c,transition:{duration:.1}}).then((()=>{ve(!1),ye.current=!1})),setTimeout((()=>fe(re.DEFAULT)),240)}}),[L,T,k,Re,be,we,C,i,P,b]),Se=(0,o.useCallback)((()=>{$(),(0,d.Np)(b,i,L,k)}),[L,k,i,$,b]),De=(0,o.useCallback)((e=>{switch(e){case 3:var t;null===(t=pe.current)||void 0===t||t.playSoundOne();break;case 2:var i;null===(i=pe.current)||void 0===i||i.playSoundTwo();break;case 1:var n;null===(n=pe.current)||void 0===n||n.playSoundThree()}}),[]),Le=(0,o.useCallback)((()=>{ue(!0),de(!1)}),[]);return(0,n.jsxs)(n.Fragment,{children:[le&&(0,n.jsx)(c.Z,{top:0,left:0,zIndex:u.y$,fullscreen:!0,children:(0,n.jsx)(te,{children:(0,n.jsx)(z,{time:3,onCountdownComplete:Le,onCountdown:De})})}),N&&(0,n.jsx)(F,{ref:pe}),(0,n.jsx)(J,{inDrag:me,"data-tome-bypass-tap-navigation":"Overlay__DragZone",style:{height:C?0:x,width:C?0:P,top:"calc(var(--mobile-header-top-padding, 0px))"},children:(0,n.jsxs)(ne,{ref:Ie,style:{top:"calc(var(--mobile-header-top-padding, 0px))",width:P},children:[(0,n.jsx)(K,{size:64,animate:he,variants:_.$S,initial:re.DEFAULT}),(0,n.jsx)(X,{size:64,animate:he,variants:_.$S,initial:re.DEFAULT})]})}),(0,n.jsx)(ie,{"data-tome-bypass-tap-navigation":"Overlay__OverlayLayer",$isMobile:C,style:{height:C?0:x,width:C?0:P,top:"calc(var(--mobile-header-top-padding, 0px))",transition:"top 0.2s ease-in-out"},children:(0,n.jsx)(ne,{style:{width:P},children:(0,n.jsxs)(Q,{style:{x:be,y:Te},variants:_.IR,animate:he,$hide:ge,children:[(0,n.jsx)(ee,{$visibility:!ae,children:(0,n.jsx)(O,{pageId:i,tomeId:b,enableVideo:(!U||D)&&N,checkForMediaDevices:j,enableRecording:D&&ce,setCanPlay:V,setScaledUp:q})}),(0,n.jsx)(I.Z,{shouldAnimateIn:C||E,shouldBeVisible:U&&!W&&!B,ref:Z,localMediaUrl:H,overlayData:t,setPlaybackPlaying:se,isInRecordMode:N,isMobile:C,tomeId:b}),Pe&&(0,n.jsx)(G,{"data-testid":"overlay_progress",children:(0,n.jsx)(m.Z,{width:24,height:24,progress:M.progress,infinite:1===M.progress})},"progressIndicator")]})})}),(0,n.jsxs)(ie,{"data-tome-bypass-tap-navigation":"Overlay__OverlayLayer","data-testid":"av_overlay_layer",$isMobile:C,style:{height:C?0:x,width:C?0:P,top:"calc(var(--mobile-header-top-padding, 0px))"},children:[(0,n.jsx)(ne,{style:{width:P},onMouseDown:e=>{e.stopPropagation()},children:(0,n.jsx)(h.Z,{menuWidth:140,menuPosition:"below",menuAlign:"click",rightClickActivated:!0,disabled:!T,itemsOrFn:[{text:S("overlay.delete"),action:Se,variant:"destructive"}],children:(0,n.jsx)(Y,{"data-testid":"av_overlay_dragger",$hide:ge,drag:(T||C)&&!D,dragConstraints:Ie,animate:we,style:{x:be,y:Te},onDrag:()=>{var e;fe(re.DRAGGING),null===(e=document.querySelector(".ProseMirror-focused"))||void 0===e||e.blur()},onDragStart:()=>{ve(!0),ye.current=!0},onDragEnd:Ee,onTap:()=>{Pe||(D||!Z.current||ye.current||Z.current.toggleVideo(),fe(re.DEFAULT))},onMouseDown:()=>{fe(re.CLICKED)}})})}),he===re.DRAGGING&&(0,n.jsx)(w.Z,{})]})]})};var se=e=>{let{overlayData:t,pageId:i,tomeId:o,canEdit:r,display:a,pageHeight:s,pageWidth:l,isMobile:d,playMode:c}=e;return t?(0,n.jsx)(ae,{overlayData:t,pageId:i,canEdit:r,tomeId:o,display:a,pageHeight:Number.isNaN(s)?0:s,pageWidth:Number.isNaN(l)?0:l,isMobile:d,playMode:c}):null}},67782:function(e,t,i){i.d(t,{$S:function(){return n},DO:function(){return a},IR:function(){return o},p3:function(){return r}});const n={default:{scale:0,opacity:0,transition:{opacity:{duration:.35,ease:[.4,0,.1,1],delay:.25},scale:{type:"spring",stiffness:550,damping:30,delay:.25}}},dragging:{scale:.5,opacity:.75,transition:{opacity:{duration:.5,ease:[.4,0,.1,1],delay:.3},scale:{type:"spring",stiffness:550,damping:30,delay:.3}}}},o={default:{scale:1,opacity:1,transition:{opacity:{duration:.3,ease:[.4,0,.1,1],delay:.3}}},clicked:{scale:.95,opacity:1},dragging:{scale:1.1,opacity:1},hidden:{opacity:0,transition:{opacity:{duration:.1,ease:[.4,0,.1,1]}}}},r=1.5,a=1.15},26634:function(e,t,i){i.d(t,{U:function(){return r},Y:function(){return a}});var n=i(59016),o=i(69336);const r=(0,n.ZP)(o.E.div).withConfig({displayName:"OverlayVideo__VideoWrapper",componentId:"sc-8df78245-0"})`
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  width: ${e=>{let{$useSmallSize:t}=e;return t?"48px":"64px"}};
  height: ${e=>{let{$useSmallSize:t}=e;return t?"48px":"64px"}};
  background-color: transparent;
  filter: drop-shadow(0px 6px 16px rgba(0, 0, 0, 0.25));
  border-radius: 50%;
  overflow: hidden;

  ${e=>{let{$hasBorder:t}=e;return t&&n.iv`
      // https://stackoverflow.com/a/14962056
      ::after {
        content: ' '; /* to ensure it displays */
        position: absolute;
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        border-radius: 50%;
        border: 1px solid rgba(255, 255, 255, 0.12);
        pointer-events: none; /* user can't click on it */
      }
    `}};
`,a=n.ZP.video.withConfig({displayName:"OverlayVideo__VideoPlayer",componentId:"sc-8df78245-1"})`
  position: absolute;
  top: 50%;
  left: 50%;
  min-height: 100%;
  min-width: 100%;
  width: 100%;
  height: 100%;
  object-fit: cover;
  visibility: ${e=>{let{$visible:t}=e;return t?"inherited":"hidden"}};
  ${e=>{let{$isFlipped:t}=e;return t&&n.iv`
      transform: translate(-50%, -50%) scaleX(-1);
    `}};
`},87258:function(e,t,i){i.d(t,{f:function(){return b},Z:function(){return C}});var n=i(85893),o=i(67294),r=i(67631),a=i.n(r),s=i(82703),l=i(69336),d=i(4480),c=i(96215),u=i(26634),p=i(67782),g=i(59016),h=i(85518),f=i(86090),m=i(49005),v=i(9228),y=i(2767);var w=(0,o.forwardRef)(((e,t)=>(0,n.jsxs)(y.Z,{ref:t,viewBox:"0 0 64 64",...e,children:[(0,n.jsx)(l.E.path,{d:"M7.00164 23.0283C5.3444 23.0279 4.00057 24.3711 4 26.0283L4.00001 38.03C4.00045 39.6873 5.34425 41.0304 7.00151 41.03H12.5089C13.5698 41.0299 14.5873 41.451 15.3379 42.2006L23.5817 50.4356C23.9569 50.8103 24.4654 51.0209 24.9957 51.0212C26.1015 51.0217 26.9984 50.1258 26.9989 49.02V15.03C26.9986 14.5001 26.7882 13.9918 26.4137 13.6168C25.6326 12.8347 24.3654 12.8339 23.5832 13.6149L15.331 21.8576C14.5805 22.6073 13.5631 23.0284 12.5022 23.0283H7.00164Z",fill:"currentColor"}),(0,n.jsx)(l.E.path,{fill:"currentColor",d:"M30.5893 17.7952C31.1051 16.5742 32.5131 16.0026 33.7341 16.5185C39.7623 19.0654 44 25.0349 44 31.9998C44 38.9646 39.7623 44.9342 33.7341 47.4811C32.5131 47.997 31.1051 47.4254 30.5893 46.2044C30.0734 44.9834 30.645 43.5754 31.866 43.0595C36.18 41.2368 39.2 36.9682 39.2 31.9998C39.2 27.0313 36.18 22.7627 31.866 20.94C30.645 20.4241 30.0734 19.0161 30.5893 17.7952Z",animate:{opacity:[0,1,1,0]},transition:{times:[.19,.2,.4,.41],duration:3,repeat:1/0,type:"linear"}}),(0,n.jsx)(l.E.path,{fill:"currentColor",d:"M38.0314 12.2418C38.7897 11.1546 40.2857 10.8881 41.3729 11.6464C47.7919 16.1238 51.9998 23.5702 51.9998 31.9998C51.9998 40.4294 47.7919 47.8758 41.3729 52.3532C40.2857 53.1116 38.7897 52.845 38.0314 51.7578C37.2731 50.6707 37.5396 49.1747 38.6268 48.4164C43.814 44.7981 47.1998 38.7942 47.1998 31.9998C47.1998 25.2054 43.814 19.2015 38.6268 15.5833C37.5396 14.8249 37.2731 13.3289 38.0314 12.2418Z",animate:{opacity:[0,1,1,0]},transition:{times:[.39,.4,.6,.61],duration:3,repeat:1/0,type:"linear"}}),(0,n.jsx)(l.E.path,{fill:"currentColor",d:"M45.0151 7.2481C45.8721 6.23699 47.3866 6.11211 48.3977 6.96918C55.4913 12.982 60 21.9657 60 32C60 42.0342 55.4913 51.0179 48.3977 57.0307C47.3866 57.8878 45.8721 57.7629 45.0151 56.7518C44.158 55.7407 44.2829 54.2262 45.294 53.3692C51.3576 48.2294 55.2 40.5646 55.2 32C55.2 23.4353 51.3576 15.7705 45.294 10.6307C44.2829 9.77366 44.158 8.25921 45.0151 7.2481Z",animate:{opacity:[0,1,1,0]},transition:{times:[.59,.6,.8,.81],duration:3,repeat:1/0,type:"linear"}})]})));const I=(0,g.ZP)(l.E.div).withConfig({displayName:"OverlayTooltip__PositionedContainer",componentId:"sc-7df33619-0"})`
  position: relative;
`;var b,T,R=e=>{let{videoWrapperRef:t,showTooltip:i,position:r,tooltipCopy:a=f.ZP.t("overlay.overlayTooltip.tooltipCopy"),shouldScale:s=!0}=e;const l=(0,g.Fg)(),d=(0,o.useRef)(null),[u,p]=(0,o.useState)({top:0,left:0});(0,o.useEffect)((()=>{var e,i;const n=null===(e=d.current)||void 0===e?void 0:e.getBoundingClientRect(),o=null===(i=t.current)||void 0===i?void 0:i.getBoundingClientRect();if(o&&n){const e=h.tq||!s?1:(0,v.k6)(),t=(-o.height/2-n.height/2)/e;let i=0;switch(r){case c._zJ.UpperRight:i=-n.width/e-10;break;case c._zJ.UpperLeft:i=o.width/e+10;case c._zJ.BottomRight:case c._zJ.BottomLeft:}p({top:t,left:i})}}),[r,t,s]);let y=10;switch(r){case c._zJ.UpperRight:case c._zJ.BottomRight:y=-10}return(0,n.jsx)(I,{initial:{opacity:0},animate:{opacity:i?1:0,scale:i?1:.9},transition:{type:"tween",duration:.5},style:{...u},children:(0,n.jsx)(m.DY,{animate:{x:[y,0,y]},transition:{repeat:1/0,type:"spring",duration:3,delay:.55},children:(0,n.jsxs)(m._v,{ref:d,$background:l.colors.tooltipOnSheetBg,children:[a,(0,n.jsx)(w,{style:{width:14,height:14,verticalAlign:"bottom",margin:"0 2"}})]})})})},x=i(61098);!function(e){e[e.NORMAL=0]="NORMAL",e[e.SMALL=1]="SMALL"}(b||(b={})),function(e){e[e.STOPPED=0]="STOPPED",e[e.PLAYING=1]="PLAYING",e[e.PAUSED=2]="PAUSED"}(T||(T={}));const P={initialWithBounce:{scale:0},withBounce:{scale:1,transition:{type:"spring",bounce:.5}},initialWithOutBounce:{scale:1},withoutBounce:{scale:1}};var C=(0,o.forwardRef)(((e,t)=>{let{overlayData:i,setPlaybackPlaying:r,isInRecordMode:g,isMobile:h,localMediaUrl:f,shouldBeVisible:m,shouldAnimateIn:v,videoProps:y,tooltipCopy:w,shouldScaleTooltip:I,size:C=b.NORMAL,tomeId:E,forceLoad:S=!1}=e;const{videoUrl:D,videoThumbnailUrl:L,videoStatus:_}=i,A=!!f,k=_===c.Kwn.Ready,M=A&&f?f:D||void 0,$=A?"":L||void 0,H=(0,o.useRef)(null),j=(0,o.useRef)(null),[O,N]=(0,o.useState)(T.STOPPED),[z,Z]=(0,o.useState)(!0),[U,W]=(0,o.useState)(!1),V=(0,o.useRef)(void 0),[F,B]=(0,d.FV)((0,x.K3)(E));(0,o.useEffect)((()=>{N(T.STOPPED)}),[M]),(0,o.useEffect)((()=>{if($&&v){const e=new Image;Z(!0),e.src=$,e.onload=()=>{Z(!1)}}else Z(!1)}),[v,$]),(0,o.useEffect)((()=>{const e=j.current;if(!A&&k&&e&&M&&!M.includes(".mp4")&&a().isSupported()){const t=new(a());t.on(a().Events.MEDIA_ATTACHED,(()=>{t.loadSource(M)})),t.attachMedia(e)}}),[M,A,k]),(0,o.useEffect)((()=>{var e;S&&(null===(e=j.current)||void 0===e||e.load())}),[M,S]);const G=(0,o.useCallback)((()=>{W(!1),j.current&&(O!==T.PLAYING?V.current=j.current.play():void 0!==V.current&&V.current.then((()=>{var e;return null===(e=j.current)||void 0===e?void 0:e.pause()})))}),[O]),J=(0,o.useCallback)((e=>{j.current&&(j.current.currentTime=e)}),[]),Y=(0,o.useCallback)((()=>{if(j.current)return j.current.currentTime}),[]),q=(0,o.useCallback)((()=>O===T.PLAYING),[O]);(0,o.useImperativeHandle)(t,(()=>({toggleVideo:G,isPlaying:q,setCurrentTime:J,currentTime:Y})));const K=h?p.DO:p.p3,X={playback:{scale:O===T.PLAYING?K:1}},Q=(0,o.useCallback)((()=>{N(T.PLAYING),r(!0),B(!0)}),[B,r]),ee=(0,o.useCallback)((()=>{N(T.PAUSED),r(!1)}),[r]),te=(0,o.useCallback)((()=>{N(T.STOPPED),r(!1)}),[r]);(0,o.useEffect)((()=>{v||W(!1)}),[v]);let ie="withoutBounce";return v&&(ie=z?"initialWithBounce":"withBounce"),(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(s.M,{children:m&&(0,n.jsx)(l.E.div,{initial:v?"initialWithBounce":"initialWithoutBounce",animate:ie,onAnimationComplete:e=>{v&&!g&&"withBounce"===e&&W(!0)},variants:P,children:(0,n.jsx)(u.U,{animate:["playback"],variants:X,style:{translateZ:"0"},ref:H,$useSmallSize:C===b.SMALL,$hasBorder:!0,children:(A||k)&&(0,n.jsx)(u.Y,{controls:!1,ref:j,src:M,playsInline:!0,$isFlipped:!0,$visible:!0,onPlay:Q,onPause:ee,onEnded:te,poster:$,"data-isavoverlay":"true","data-testid":(k?"remote":"local")+"_overlay_video",...y})})},"playbackOverlay")}),U&&!F&&(0,n.jsx)(R,{tooltipCopy:w,showTooltip:U,videoWrapperRef:H,position:i.position??c._zJ.UpperRight,shouldScale:I})]})}))},61098:function(e,t,i){i.d(t,{$6:function(){return r},HV:function(){return s},K3:function(){return u},LW:function(){return l},ep:function(){return d},fT:function(){return c},jd:function(){return o},wo:function(){return a}});var n=i(4480);const o=(0,n.cn)({key:"audioDevicesState",default:[]}),r=(0,n.cn)({key:"videoDevicesState",default:[]}),a=(0,n.cn)({key:"desiredRecordingStateState",default:!1}),s=(0,n.cn)({key:"videoDeviceIdState",default:null}),l=(0,n.cn)({key:"audioDeviceIdState",default:null}),d=(0,n.cn)({key:"overlayRecordingErrorsState",default:"NONE"}),c=(0,n.cn)({key:"overlayStatusState",default:"idle"}),u=(0,n.xu)({key:"hasAnOverlayBeenPlayedState",default:!1})},15135:function(e,t,i){var n;function o(e){let{widthToBeSquishedInUnits:t,deltaInUnits:i,numSquishedTiles:n,totalUnitsAvailable:o}=e,r=!1;const a=t-i;let s;return a<n?(r=!0,s=n):s=Math.round(a),{sideInUnits:s,otherSideInUnits:o-s,reachedMinimum:r}}function r(e){let{numOfLeftTilesToAdj:t,numOfRightTilesToAdj:i,leftWidthInUnitsPreResize:n,rightWidthInUnitsPreResize:r,deltaInUnits:a}=e;const s=n+r;let l,d,c;a<0?(c=o({widthToBeSquishedInUnits:n,deltaInUnits:-a,numSquishedTiles:t,totalUnitsAvailable:s}),l=c.sideInUnits,d=c.otherSideInUnits):(c=o({widthToBeSquishedInUnits:r,deltaInUnits:a,numSquishedTiles:i,totalUnitsAvailable:s}),d=c.sideInUnits,l=c.otherSideInUnits);return{leftTileWidthInUnits:l/t,rightTileWidthInUnits:d/i,reachedMinimum:c.reachedMinimum}}function a(e){let{leftWidthInUnitsPreResize:t,rightWidthInUnitsPreResize:i,numOfLeftTilesToAdj:n,numOfRightTilesToAdj:o,deltaPx:r}=e;return r<0&&t<=n||r>0&&i<=o}i.d(t,{e9:function(){return r},jm:function(){return a},yV:function(){return n}}),function(e){e.NOOP="noop",e.REACHED_MINIMUM="reached_minimum",e.SUCCESS="success"}(n||(n={}))},28773:function(e,t,i){i.d(t,{Z:function(){return g}});var n=i(67294),o=i(12887),r=i(41350),a=i(37683);var s=i(67591),l=i(69290),d=i(7450),c=i(32011),u=i(15135);var p=class{update(e,t,i,n,o){const r=l.ZP.fromLayout(e,t);this.persistLayout=i,this.pixelsPerHeightUnit=n,this.rowPadding=o,r.isEquivalentTo(this.frontendPageLayout)||(this.frontendPageLayout=r,this.rowHeights.clear(),this.tileWidths.clear(),this.updateActualHeights(),this.updateAllTileWidths())}isSingleTilePage(e){return this.frontendPageLayout.isSingleTilePage(e)}isSingleTileRow(e){return this.frontendPageLayout.isSingleTileRow(e)}getRowHeight(e){return this.rowHeights.get(e)}getTileHeightInPx(e){const t=this.rowHeights.get(e);return void 0===t?t:t*this.pixelsPerHeightUnit-this.rowPadding}triggerLayoutRecalculationAndRender(){this.updateActualHeights(),this.triggerRender()}findNoopDropzones(e){return this.frontendPageLayout.findNoopDropzones(e)}tileRefCallback(e){return t=>{null!==t?this.tileRefs.set(e,t):this.tileRefs.delete(e)}}sumOfRowHeightsInUnits(){return Array.from(this.rowHeights.values()).reduce(((e,t)=>e+t),0)}getTilePosition(e,t,i){const n=this.frontendPageLayout.rowByTileId(e);if(void 0===n)throw new Error(`Row not found for tile ${e}`);return this.getTilePositionFromRow(e,n,t,i)}getTilePositionFromRow(e,t,i,n){let o=0;for(const e of this.frontendPageLayout.pageLayoutRows){if(t.id===e.id)break;o+=this.getRowHeight(e.id)}let r=0;for(const o of t.tiles){if(o.tileId===e)break;r+=this.getTileWidthInPx(o.tileId,i,n)??0}const a=o*this.pixelsPerHeightUnit+n,s=this.getTileWidthInPx(e,i,n)??0;return{top:a,left:r+n*(t.tiles.findIndex((t=>t.tileId===e))+1),width:s,height:this.getRowHeight(t.id)*this.pixelsPerHeightUnit-n}}getTileRowId(e){var t;return null===(t=this.frontendPageLayout.rowByTileId(e))||void 0===t?void 0:t.id}getTileIndexInRow(e){var t;return null===(t=this.frontendPageLayout.rowByTileId(e))||void 0===t?void 0:t.tiles.findIndex((t=>t.tileId===e))}getOrderedTileIds(e){const t=e instanceof Set?e:new Set(e);return this.frontendPageLayout.tiles.filter((e=>t.has(e.tileId))).map((e=>e.tileId))}get orderedTileIDs(){return this.frontendPageLayout.tiles.map((e=>e.tileId))}getRowAndIndexOfLastTile(e){const t=this.frontendPageLayout.pageLayoutRows.filter((t=>t.tiles.map((e=>e.tileId)).some((t=>e.includes(t))))).pop();if(void 0===t)return;const i=t.tiles.map(((e,t)=>({tile:e,index:t}))).filter((t=>e.includes(t.tile.tileId))).reduce(((e,t)=>t.index>e.index?t:e)).index;return-1!==i?{rowId:t.id,index:i}:void 0}replaceTile(e,t,i){return this.frontendPageLayout.replaceTileInLayout(e,t,i)}addTileToNewRow(e,t,i){const n=this.frontendPageLayout.addTileToNewRow(e,{kind:d.DV.NEW_TILE},t,i,this.getRowHeight.bind(this));return this.updateRowHeightsAndTileWidthsAfterLayoutChange(),n}addTileToExistingRow(e,t,i,n,o){const r=this.frontendPageLayout.addTileToExistingRow(e,t,i,n,o,this.getRowHeight.bind(this));return this.updateRowHeightsAndTileWidthsAfterLayoutChange(),r}addTileToEndOfPage(e,t,i){const n=this.frontendPageLayout.addTileToEndOfPage(e,t,i,this.getRowHeight.bind(this));return this.updateRowHeightsAndTileWidthsAfterLayoutChange(),n}deleteTile(e){this.frontendPageLayout.deleteTile(e,this.getRowHeight.bind(this)),this.updateRowHeightsAndTileWidthsAfterLayoutChange()}deleteTiles(e){e.forEach((e=>{this.frontendPageLayout.deleteTile(e,this.getRowHeight.bind(this))})),this.updateRowHeightsAndTileWidthsAfterLayoutChange()}moveTiles(e,t){this.conditionallyUpdateAndPersistLayout((i=>(i.moveTiles(e,t,this.getRowHeight.bind(this)),!0)))}moveTile(e,t){this.moveTiles([e],t)}getRowResizeHandlers(e){return{handleResizeStart:()=>{this.rowHeightPreResize=this.getRowHeight(e)},handleResize:t=>{const i=function(e,t,i){const n=t+Math.round(e);return Math.max(n,i)}(t/this.pixelsPerHeightUnit,this.rowHeightPreResize,this.getRowMinimumHeight(e));this.rowHeights.get(e)!==i&&(this.rowHeights.set(e,i),this.updateActualHeights(e),this.triggerRender())},handleResizeComplete:()=>{const t=this.getRowHeight(e),i=this.frontendPageLayout.getTileTypesForRow(e).map((e=>(0,c.g)(e))).every((e=>e===c.Y.FIXED));let n;n=t===this.getRowMinimumHeight(e)&&i?null:t/s.Cj,this.updateRowHeight(e,n),this.rowHeightPreResize=void 0}}}sumTileWidthsInUnits(e){let{row:t,start:i,end:n}=e;return t.tiles.slice(i,n).reduce(((e,t)=>e+(this.tileWidths.get(t.tileId)??0)),0)*s.w4}getTileResizeHandlers(e,t,i){var n=this;let o,r,a,l,d=!1;return{handleResizeStart:function(){d=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const i=n.frontendPageLayout.rowById(t);i&&(o=n.sumTileWidthsInUnits({row:i,start:d?e-1:0,end:e}),r=n.sumTileWidthsInUnits({row:i,start:e,end:d?e+1:void 0}),a=d?1:e,l=d?1:i.numTiles()-e)},handleResize:n=>{const c=this.frontendPageLayout.rowById(t);if(!c)return u.yV.NOOP;if(0===n)return u.yV.NOOP;if((0,u.jm)({numOfLeftTilesToAdj:a,numOfRightTilesToAdj:l,leftWidthInUnitsPreResize:o,rightWidthInUnitsPreResize:r,deltaPx:n}))return u.yV.REACHED_MINIMUM;const p=n/i*s.w4,g=(0,u.e9)({numOfLeftTilesToAdj:a,numOfRightTilesToAdj:l,leftWidthInUnitsPreResize:o,rightWidthInUnitsPreResize:r,deltaInUnits:p}),h=g.leftTileWidthInUnits/s.w4,f=g.rightTileWidthInUnits/s.w4,m=d?c.tiles.slice(e-1,e+1):c.tiles,v=d?1:e;return m.forEach(((e,t)=>{t<v?this.tileWidths.set(e.tileId,h):this.tileWidths.set(e.tileId,f)})),this.triggerRender(),g.reachedMinimum?u.yV.REACHED_MINIMUM:u.yV.SUCCESS},handleResizeComplete:()=>{const e=this.frontendPageLayout.rowById(t);if(!e)return;const i=new Map;e.tiles.forEach((e=>{i.set(e.tileId,this.tileWidths.get(e.tileId))})),this.updateTileWidths(t,i)}}}distributeWidths(e){const t=this.frontendPageLayout.rowById(e);if(!t)return;const i=t.calculateDistributedRelativeWidth(),n=new Map;t.tiles.forEach((e=>{this.tileWidths.set(e.tileId,i),n.set(e.tileId,i)})),this.triggerRender(),this.updateTileWidths(e,n)}alreadyEvenlyDistributed(e){const t=this.frontendPageLayout.rowById(e);if(!t)return!0;const i=t.getCurrentRelativeWidthDistributed();return t.tiles.every((e=>e.relativeWidth===i))}tileNeighborByDirection(e,t,i){return this.frontendPageLayout.tileNeighborByDirection(e,t,i)}getTileWidthInPx(e,t,i){if(void 0===this.frontendPageLayout.rowByTileId(e))return;return(t-i)*this.tileWidths.get(e)-i}getTileRelativeWidth(e){return this.tileWidths.get(e)}getRowRelativeHeight(e){return this.rowHeights.get(e)}getTileWidthInUnits(e){if(!this.frontendPageLayout.rowByTileId(e))return;return this.tileWidths.get(e)*s.w4}getTileElements(){const e=new Map;return this.tileRefs.forEach(((t,i)=>{const n=t.getRef().current;n&&e.set(i,n)})),e}getLastRowHeightIfLastRow(e){if(this.frontendPageLayout.lastRow.id===e)return this.lastRowHeight()}getRowMinimumHeight(e){return(0,d.nA)(this.getHeightsForRowFromTiles(this.frontendPageLayout.rowById(e)),this.getLastRowHeightIfLastRow(e))}updateRowHeight(e,t){this.conditionallyUpdateAndPersistLayout((i=>{const n=i.rowById(e);return!!n&&(n.row.relativeHeight=t,!0)}))}updateTileWidths(e,t){this.conditionallyUpdateAndPersistLayout((i=>{const n=i.rowById(e);return!!n&&(t.forEach(((e,t)=>{const i=n.tileById(t);i&&(i.relativeWidth=e)})),!0)}))}lastRowHeight(e){const t=e??this.rowHeights;let i=0;const n=this.frontendPageLayout.pageLayoutRows.map((e=>e.id));for(const[e,o]of t)n.includes(e)&&e!==this.frontendPageLayout.lastRow.id&&(i+=o);return s.Cj-i}getHeightsForRowFromTiles(e){const t=e.tiles.map((e=>e.tileId)),i=new Map([...this.tileRefs].filter((e=>{let[i]=e;return t.includes(i)})));return Array.from(i.values(),(e=>e.getHeight().addPixelsIfAppropriate(this.rowPadding).toUnits(this.pixelsPerHeightUnit)))}updateActualHeights(e){this.frontendPageLayout.pageLayoutRows.forEach((t=>{if(t.id===e)return;const i=(0,d.tn)(t.row.relativeHeight,this.getHeightsForRowFromTiles(t),this.getLastRowHeightIfLastRow(t.id));this.rowHeights.set(t.id,i)}))}updateAllTileWidths(){this.frontendPageLayout.pageLayoutRows.forEach((e=>{this.updateTileWidthsForRow(e.id)}))}updateTileWidthsForRow(e){const t=this.frontendPageLayout.rowById(e);if(void 0===t)throw new Error(`Row not found for row ${e}`);const i=t.relativeWidthSum();t.tiles.forEach((e=>{const t=e.relativeWidth/i;this.tileWidths.set(e.tileId,t)}))}setLastRowRelativeHeightIfNeeded(){const e=this.frontendPageLayout.lastRow;return!this.frontendPageLayout.getTileTypesForRow(e.id).map((e=>(0,c.g)(e))).every((e=>e===c.Y.FIXED))&&(!((e.row.relativeHeight??0)*s.Cj>=this.lastRowHeight())&&(e.row.relativeHeight=this.rowHeights.get(e.id)/s.Cj,!0))}conditionallyUpdateAndPersistLayout(e){const t=l.ZP.copyFrom(this.frontendPageLayout);e(t)&&(this.frontendPageLayout.isEquivalentTo(t)||(this.frontendPageLayout=t,this.updateRowHeightsAndTileWidthsAfterLayoutChange(),this.persistLayout(this.frontendPageLayout.getLayout())))}updateRowHeightsAndTileWidthsAfterLayoutChange(){this.rowHeights.clear(),this.updateActualHeights(),this.tileWidths.clear(),this.updateAllTileWidths();this.setLastRowRelativeHeightIfNeeded()}constructor(e,t,i,n,o,r){this.frontendPageLayout=l.ZP.fromLayout(e,t),this.persistLayout=i,this.tileRefs=new Map,this.pixelsPerHeightUnit=n,this.rowPadding=o,this.triggerRender=r,this.rowHeights=new Map,this.tileWidths=new Map,this.updateActualHeights(),this.updateAllTileWidths(),this.rowHeightPreResize=void 0}};function g(e){let{tomeId:t,pageId:i,pageKind:s,layout:l,tiles:d,pixelsPerHeightUnit:c,rowPadding:u,persistToBackend:g}=e;const{addController:h,getController:f,removeController:m}=(0,n.useContext)(a.Z),{apolloClient:v,clientId:y}=(0,r.bp)(),[,w]=(0,n.useState)(0),I=()=>{w((e=>e+1))},b=(0,n.useCallback)((e=>{(0,o.T$)(t,{id:i,layout:e},v,y)}),[v,y,i,t]),T=g?b:()=>{};(0,n.useEffect)((()=>()=>{m(s,i)}),[i,s,m]);const R=new Map;null!=d&&d.forEach((e=>R.set(e.id,e.type)));let x=f(s,i);return x?x.update(l,R,T,c,u):(x=new p(l,R,T,c,u,I),h(s,i,x)),x}},29605:function(e,t,i){var n=i(67294),o=i(15764);t.Z=function(){let{delayMs:e=0}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{scrollingPageRef:t}=(0,n.useContext)(o.Z),i=(0,n.useRef)(),r=(0,n.useRef)(!1),a=(0,n.useRef)(),s=(0,n.useCallback)(((e,t)=>e>=t-100),[]),l=(0,n.useCallback)(((e,t)=>e<t+100),[]),d=(0,n.useCallback)((()=>{a.current&&clearTimeout(a.current),r.current=!0}),[]),c=(0,n.useCallback)((function(n){let o=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(r.current){if(o)return;r.current=!1}if(t.current){var d,u;const o=t.current;(null===(d=n)||void 0===d?void 0:d.clientY)&&(null===(u=n)||void 0===u?void 0:u.clientX)&&(i.current={x:n.clientX,y:n.clientY});const r=o.getBoundingClientRect(),p=o.scrollHeight>r.height,g=o.scrollHeight-o.offsetHeight;if(!p)return;if(!i.current)return;s(i.current.y,document.body.scrollHeight)&&o.scrollTop<g?(o.scrollTop+=1,a.current=setTimeout((()=>{c(null,!0)}),e)):l(i.current.y,0)&&o.scrollTop>0&&(o.scrollTop-=1,a.current=setTimeout((()=>{c(null,!0)}),e))}}),[e,s,l,t]);return(0,n.useMemo)((()=>({scrollContainerIfNeeded:c,cancelAnyScrolling:d})),[d,c])}},24296:function(e,t,i){i.d(t,{I:function(){return d}});var n=i(85893),o=i(89755),r=i.n(o),a=i(67294),s=i(23610),l=i(34296);const d=e=>!!e&&(e.shouldUseThemedLogo?!!e.imageUrlDark||!!e.imageUrlLight:!!e.imageUrlGlobal);t.Z=e=>{let{show:t,logo:i,theme:o}=e;const[d,c]=(0,a.useState)(!1),{UITheme:u}=(0,s.Z)(o.id,o.colors),p=((e,t)=>!e.shouldUseThemedLogo&&e.imageUrlGlobal?e.imageUrlGlobal:"light"===t&&e.imageUrlLight&&e.shouldUseThemedLogo?e.imageUrlLight:"dark"===t&&e.imageUrlDark&&e.shouldUseThemedLogo?e.imageUrlDark:void 0)(i,u);return p&&t?(0,n.jsx)(r(),{alt:"workspace-logo",draggable:!1,src:p,layout:"fixed",height:24,width:80,objectFit:"contain",objectPosition:0,loader:l.Z,style:{opacity:d?1:0},onLoad:()=>c(!0),"data-testid":"workspace_logo"}):null}},36512:function(e,t,i){i.d(t,{D:function(){return n},L:function(){return c}});var n,o=i(64310),r=i(50576),a=i(67294),s=i(4480),l=i(61098),d=i(16401);function c(e){let{onStop:t=(()=>null)}=e;const i=(0,a.useRef)(null),c=(0,a.useRef)([]),u=(0,a.useRef)(null),p=(0,a.useRef)(null),g=(0,s.Zl)(l.fT),h=(0,s.Zl)(l.ep),f=(0,s.Zl)(l.jd),m=(0,s.Zl)(l.$6),v=(0,s.sJ)(l.LW),y=(0,s.sJ)(l.HV),w=(0,a.useCallback)((()=>{const e=[],t=[];(0,d.GE)()?navigator.mediaDevices.enumerateDevices().then((i=>{i.forEach((i=>{i.deviceId&&("audioinput"===i.kind?e.push(i):"videoinput"===i.kind&&t.push(i))})),0===e.length?f((e=>0===e.length?e:[])):f((t=>{var i,n;const o=null===(i=t)||void 0===i?void 0:i.map((e=>e.deviceId)),a=null===(n=t)||void 0===n?void 0:n.map((e=>e.label));return(0,r.Z)(o,e.map((e=>e.deviceId)))&&(0,r.Z)(a,e.map((e=>e.label)))?t:e})),0===t.length?m((e=>0===e.length?e:[])):m((e=>{var i,n;const o=null===(i=e)||void 0===i?void 0:i.map((e=>e.deviceId)),a=null===(n=e)||void 0===n?void 0:n.map((e=>e.label));return(0,r.Z)(o,t.map((e=>e.deviceId)))&&(0,r.Z)(a,t.map((e=>e.label)))?e:t}))})).catch((e=>{console.log(`${e.name}: ${e.message}`)})):(f((e=>0===e.length?e:[])),m((e=>0===e.length?e:[])))}),[f,m]),I=(0,a.useCallback)((async()=>{g("acquiring_media");const e={audio:!0,video:!0};v&&(e.audio={deviceId:v}),y&&(e.video={deviceId:y});try{if((0,d.t1)()){const t=await window.navigator.mediaDevices.getUserMedia(e);w(),u.current=t}g("idle"),h(n.NONE)}catch(e){o.v.addAction("getMediaStreamError",{error:e.name}),h(e.name),g("idle")}}),[g,v,y,h,w]),b=(0,a.useCallback)((async()=>{await window.navigator.mediaDevices.getUserMedia({audio:!0,video:!0}).catch((e=>{o.v.addAction("getMediaStreamError",{error:e.name}),h(e.name),g("idle")})),w()}),[h,g,w]);(0,a.useEffect)((()=>{(0,d.DE)()||(o.v.addAction("getMediaStreamError",{error:n.UNSUPPORTED_BROWSER}),h(n.UNSUPPORTED_BROWSER)),w(),(0,d.GE)()&&(navigator.mediaDevices.ondevicechange=w)}),[w,h]);const T=(0,s._8)((e=>{let{snapshot:t}=e;return async()=>{const e=t.getLoadable(l.fT).getValue(),i="idle"===e||"stopped"===e;!u.current&&i&&await I()}}),[I]),R=(0,a.useCallback)((()=>{const e=new Blob(c.current,{type:"video/mp4"}),i=URL.createObjectURL(e);g("stopped"),t(i,e)}),[t,g]),x=e=>{let{data:t}=e;c.current.push(t)},P=(0,a.useCallback)((async()=>{if(h(n.NONE),p.current){p.current.getTracks().some((e=>"ended"===e.readyState))&&await I(),(0,d.DE)()?(i.current=new MediaRecorder(p.current),i.current.ondataavailable=x,i.current.onstop=R,i.current.onerror=()=>{h(n.NO_RECORDER),g("idle")},i.current.start(),g("recording")):(h(n.UNSUPPORTED_BROWSER),o.v.addAction("getMediaStreamError",{error:n.UNSUPPORTED_BROWSER}))}}),[I,R,h,g]),C=(0,a.useCallback)((()=>{i.current&&"inactive"!==i.current.state&&(g("stopping"),i.current.stop(),p.current&&p.current.getTracks().forEach((e=>e.stop())),u.current&&u.current.getTracks().forEach((e=>e.stop())),c.current=[])}),[g]),E=(0,a.useCallback)((()=>{u.current&&(u.current.getTracks().forEach((e=>e.stop())),u.current=null)}),[]);return(0,a.useEffect)((()=>{(v||y)&&u.current&&(E(),I())}),[v,I,E,y]),{startRecording:P,stopRecording:C,turnVideoOn:T,turnVideoOff:E,previewStream:u.current,exportStream:p,checkPermissionsAndUpdateMediaDevices:b}}!function(e){e.ABORT_ERROR="AbortError",e.NOT_ALLOWED_ERROR="NotAllowedError",e.NOT_FOUND_ERROR="NotFoundError",e.NOT_READABLE_ERROR="NotReadableError",e.OVERCONSTRAINED_ERROR="OverconstrainedError",e.TYPE_ERROR="TypeError",e.NONE="NONE",e.NO_RECORDER="recorder_error",e.UNSUPPORTED_BROWSER="unsupported_browser",e.MIME_TYPE_NOT_SUPPORTED="mime_type_not_supported"}(n||(n={}))},9043:function(e,t,i){i.d(t,{T0:function(){return p},SG:function(){return h},ZP:function(){return f}});var n=i(67294),o=i(64310),r=i(1922);const a=e=>window.btoa(encodeURIComponent(JSON.stringify(e))),s=e=>JSON.parse(decodeURIComponent(window.atob(e)));var l=i(9228),d=i(33471);const c=new Set(["png","gif","jpeg","jpg","svg","webp","bmp","tiff","heif","heic","cr2","nef","psd"]),u=new Set(["flv","ts","mp4","m3u8","3gp","mov","avi","wmv","mpg","mpeg","webm"]);var p,g=i(97732);!function(e){e.TILES="application/x-tome-tiles-data-v1",e.PAGES="application/x-tome-pages-data-v1"}(p||(p={}));const h="tome-paste-action";var f=e=>{let{dataTransferType:t,disabled:i,handleCut:f,handleCopy:m,handlePaste:v,handleFilePaste:y}=e;const{t:w}=(0,r.$G)(),I=(0,n.useCallback)((()=>{switch(t){case p.TILES:return"data-tome-tiles-v1";case p.PAGES:return"data-tome-pages-v1";default:throw new Error(`Unknown dataTransferType: ${t}`)}}),[t]),b=(0,n.useCallback)((e=>{const t=document.createElement("span");return t.setAttribute(I(),e),t}),[I]),T=(0,n.useCallback)(((e,i)=>{const n=a(i);n&&(e.setData(t,n),e.setData("text/html",b(n).outerHTML))}),[t,b]),R=(0,n.useCallback)((e=>{const t=a(e);return t?[new ClipboardItem({"text/html":new Blob([b(t).outerHTML],{type:"text/html"})})]:null}),[b]),x=(0,n.useCallback)((async()=>{if(!f)return null;const e=f(null);if(!e)return null;try{if(!e)return null;const t=R(e);if(!t||!navigator.clipboard)return null;try{await navigator.clipboard.write(t)}catch{}}catch(e){o.v.addError(`Failed to perform cut action ${e}`)}return null}),[R,f]),P=(0,n.useCallback)((e=>{if(!f)return null;const t=f(e);if(!t)return null;e.preventDefault();try{if(!e.clipboardData)return null;T(e.clipboardData,t)}catch(e){o.v.addError(`Failed to perform cut action ${e}`)}return null}),[f,T]),C=(0,n.useCallback)((async()=>{if(!m)return null;const e=m(null);if(!e)return null;try{if(!e)return null;const t=R(e);if(!t||!navigator.clipboard)return null;try{await navigator.clipboard.write(t)}catch{}}catch(e){o.v.addError(`Failed to perform copy action ${e}`)}return null}),[R,m]),E=(0,n.useCallback)((e=>{if(!m)return null;const t=m(e);if(!t)return null;e.preventDefault();try{if(!e.clipboardData)return null;T(e.clipboardData,t)}catch(e){o.v.addError(`Failed to perform copy action ${e}`)}return null}),[m,T]),S=(0,n.useCallback)((async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!v||!navigator.clipboard)return;try{if("undefined"!=typeof document&&document.execCommand("paste"))return}catch{}let i=[];try{i=await navigator.clipboard.read()}catch{}if(!i.length)return;const n=i[0];let r=null;if(n.types.includes("text/plain")){const e=await(await n.getType("text/plain")).text(),i=new RegExp(/[^\\]*\.(\w+)$/).exec(e);if(i){const e=i[1];(u.has(e)||c.has(e)&&!t.isReplace)&&(0,l.ak)({message:w("hooks.tile.menu.pasteInstruction",{commandKeyLabel:(0,d.l_)()})})}}if(!n.types.includes("text/html"))return;const a=await(await n.getType("text/html")).text();if(a){const e=new RegExp(`${I()}="([^"]+)"`,"g").exec(a);e&&(r=e[1])}if(r)try{const e=s(r);v(null,e,t)}catch(e){o.v.addError(`Failed to perform paste action ${e}`)}}),[v,I,w]),D=(0,n.useCallback)(((e,i)=>{var n,r,a,l;const d=null===(n=e.clipboardData)||void 0===n?void 0:n.files;if((null===(r=d)||void 0===r?void 0:r.length)&&!(null===(a=i)||void 0===a?void 0:a.isReplace)){if(y){const t=Array.from(d);y(e,t)}return}if(!v)return;let c=(null===(l=e.clipboardData)||void 0===l?void 0:l.getData(t))||null;if(!c){var u;const t=null===(u=e.clipboardData)||void 0===u?void 0:u.getData("text/html");if(t){const e=new RegExp(`${I()}="([^"]+)"`,"g").exec(t);e&&(c=e[1])}}if(c){e.preventDefault();try{const t=s(c);v(e,t,i)}catch(e){o.v.addError(`Failed to perform paste action ${e}`)}}}),[t,y,v,I]),L=(0,n.useCallback)((e=>{var t,i;(null===(i=e)||void 0===i||null===(t=i.data)||void 0===t?void 0:t.type)===h&&S(e)}),[S]);return(0,n.useEffect)((()=>(i||window.addEventListener("message",L),()=>{window.removeEventListener("message",L)})),[i,m,f,v,L]),(0,g.Z)({disabled:i,onCut:P,onCopy:E,onPaste:D}),{performCutAction:x,performCopyAction:C,performPasteAction:S}}},69146:function(e,t,i){var n=i(67294),o=i(4480),r=i(88698),a=i(94232),s=i(76690),l=i(65164),d=i(50921);t.Z=e=>{let{addTilesInPage:t}=e;const i=(0,o._8)((e=>{let{set:i}=e;return(e,n,o)=>{const r=t(o,n);return r&&r.forEach(((t,n)=>{i((0,a.vw)(t),(0,a.aY)(e[n]))})),r}}),[t]),c=(0,n.useCallback)(((e,t,n)=>{const o=[];return t.forEach((e=>{"IMAGE"===e?o.push({type:"IMAGE",contentLink:null,imageAttributes:{...l.A},mediaTileData:{...r.R}}):"VIDEO"===e&&o.push({type:"VIDEO",videoTileData:{...s.C},mediaTileData:{...r.R}})})),o.length?i(n,e,o):null}),[i]);return{onInsertFiles:(0,n.useCallback)(((e,t)=>{const i=[],n=[],o=[];return e.forEach((e=>{(0,d.QQ)(e)?(i.push(e),o.push("IMAGE")):e.type.startsWith("video/")?(i.push(e),o.push("VIDEO")):n.push(e)})),c(t,o,e),n}),[c])}}},37511:function(e,t,i){i.d(t,{Z:function(){return o}});var n=i(67294);function o(e){const[t,i]=(0,n.useState)(!1);return(0,n.useEffect)((()=>{e>0&&i(!0)}),[e]),t}},35527:function(e,t,i){var n;i.d(t,{A:function(){return n}}),function(e){e.ADD_TILE="ADD_TILE",e.MOVE_TILE="MOVE_TILE"}(n||(n={}))},97808:function(e,t,i){i.d(t,{z:function(){return d}});var n=i(25934),o=i(96215),r=i(6990);function a(e,t){var i;const{tomeView:n,anonymousView:r}=t;if(null===(i=r)||void 0===i?void 0:i.anonymousViews){const t=`Tome:${r.tomeId}`;e.modify({id:t,fields:{anonymousViews(){return r.anonymousViews}}})}if(!n)return;const a=e.identify(n);if(e.readFragment({id:a,fragment:o.bMw,fragmentName:"TomeActivityFragment"}))e.modify({id:a,fields:{lastTimestamp(){return n.lastTimestamp},lastPresenceType(){return n.lastPresenceType},active(){return n.active},pageId(){return n.pageId}}});else{const t=`Tome:${n.tomeId}`;if(e.readFragment({id:t,fragment:o.CIe,fragmentName:"TomeViewsFragment"})){const t=e.writeFragment({id:a,fragment:o.bMw,data:n,fragmentName:"TomeActivityFragment"});e.modify({id:`Tome:${n.tomeId}`,fields:{views(){return[t,...arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]]}}})}else e.writeFragment({id:t,fragment:o.CIe,data:{__typename:"Tome",id:n.tomeId,views:[n],anonymousViews:0},fragmentName:"TomeViewsFragment"})}}function s(e,t){const i=t.identify(e);if(t.readFragment({id:i,fragment:o.bMw,fragmentName:"TomeActivityFragment"}))t.modify({id:i,fields:{lastTimestamp(){return e.lastTimestamp},lastPresenceType(){return e.lastPresenceType},pageId(){return e.pageId},active(){return e.active}}});else{const n=`Page:${e.pageId}`;if(t.readFragment({id:n,fragment:o.rCt,fragmentName:"PageViewsFragment"})){const r=t.writeFragment({id:i,fragment:o.bMw,data:e,fragmentName:"TomeActivityFragment"});t.modify({id:n,fields:{views(){return[r,...arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]]}}})}else t.writeFragment({id:n,fragment:o.rCt,data:{__typename:"Page",id:e.pageId,views:[e]},fragmentName:"PageViewsFragment"})}}function l(e,t){const{pageView:i,previousPageView:n}=t;i&&s(i,e),n&&s(n,e)}const d={reportViewPresence:function(e,t,i,s){var d;const c=e.cache.readQuery({query:o.fkZ}),{me:u}=c||{},p=(null===(d=u)||void 0===d?void 0:d.id)||t,g=u?{__typename:"User",id:u.id,name:u.name,email:u.email,profileImage:u.profileImage,pending:u.pending,createdAt:"",updatedAt:"",status:u.status,creditsAvailable:0}:{__typename:"User",id:t,name:"anonymous",email:"anonymous",profileImage:null,pending:!1,createdAt:"",updatedAt:"",status:o.J0j.Active,creditsAvailable:0},h=e.cache.readFragment({id:`TomeActivity:${i}_${p}`,fragment:o.bMw,fragmentName:"TomeActivityFragment"}),f=(new Date).toISOString();let m;h&&h.active&&h.pageId&&(m={__typename:"TomeActivity",id:`${i}_${h.pageId}_${p}`,lastPresenceType:o.NgV.TomeView,lastTimestamp:f,tomeId:i,pageId:s,userId:p,user:g,active:!1});const v={__typename:"PresenceEdit",tomeView:{__typename:"TomeActivity",id:`${i}_${p}`,lastPresenceType:o.NgV.TomeView,lastTimestamp:f,tomeId:i,pageId:s,userId:p,user:g,active:!0,isGuest:!1},pageView:{__typename:"TomeActivity",id:`${i}_${s}_${p}`,lastPresenceType:o.NgV.TomeView,lastTimestamp:f,tomeId:i,pageId:s,userId:p,user:g,active:!0,isGuest:!1},previousPageView:m};a(e.cache,v),l(e.cache,v),(0,r.Z)((()=>e.mutate({mutation:o.CHh,variables:{editId:(0,n.Z)(),clientId:t,tomeId:i,type:o.NgV.TomeView,pageId:s}})))},reportWorkspacePresence:function(e,t){const i=e.cache.readQuery({query:o.fkZ});i&&i.me&&e.mutate({mutation:o.CHh,variables:{editId:(0,n.Z)(),clientId:t,type:o.NgV.Workspace},update:(e,t)=>{let{data:i}=t;var n,o;const r=null===(n=i)||void 0===n?void 0:n.reportPresence;"PresenceEdit"===(null===(o=r)||void 0===o?void 0:o.__typename)&&(a(e,r),l(e,r))}})},updateTomePresenceWithPresenceEdit:a,updatePagePresenceWithPresenceEdit:l}},13847:function(e,t,i){i.d(t,{I2:function(){return f},Np:function(){return h},XL:function(){return v},Yt:function(){return g},o1:function(){return m},w8:function(){return y}});var n=i(25934),o=i(86090),r=i(96215),a=i(83694),s=i(9228);function l(e,t){return e.cache.readFragment({id:`Page:${t}`,fragment:r.IyH,fragmentName:"PageAttributesFragment"})}function d(e){var t;const i={...e,page:{overlay:{...null===(t=e.page)||void 0===t?void 0:t.overlay}}};return delete i.page.overlay.videoUrl,delete i.page.overlay.videoThumbnailUrl,i}function c(e){return{...e,apply:e.apply.map((e=>d(e))),revert:e.revert.map((e=>d(e)))}}function u(e,t,i,n,o){var a;const s=l(t,e),d=[{operation:r.C8.UpdatePage,id:e,page:{overlay:{...null===(a=s)||void 0===a?void 0:a.overlay}}}],{overlay:c}=d[0].page;return null===i?c.videoId=null:void 0!==i&&(c.videoId=i),void 0!==n&&(c.videoStatus=n),o&&(c.position=o),d}function p(e,t,i,n){var o;const a=l(t,e),s=[{operation:r.C8.UpdatePage,id:e,page:{overlay:{...null===(o=a)||void 0===o?void 0:o.overlay}}}],{overlay:d}=s[0].page;return n&&(d.videoStatus=n),null===i?d.videoId=null:void 0!==i&&(d.videoId=i),s}function g(e,t,i,o){const s=u(t,i,void 0,r.Kwn.Uploaded,void 0),l=p(t,i,null,r.Kwn.WaitingForCreation),d={id:(0,n.Z)(),tomeId:e,clientId:o,apply:s,revert:l};a.Q.submitMutation(i,c(d),d,!0)}function h(e,t,i,l){const d=u(t,i,null,r.Kwn.WaitingForCreation,void 0),g=p(t,i,void 0,void 0),h={id:(0,n.Z)(),tomeId:e,clientId:l,apply:d,revert:g};a.Q.submitMutation(i,c(h),h),(0,s.ak)({message:o.ZP.t("logic.pageOverlay.recordingDeletedMessage"),action:"undo"})}function f(e,t,i,o,r){const s=u(t,i,void 0,void 0,r),l=p(t,i,void 0,void 0),d={id:(0,n.Z)(),tomeId:e,clientId:o,apply:s,revert:l};a.Q.submitMutation(i,c(d),d)}function m(e,t,i,o){const s=u(t,i,null,r.Kwn.WaitingForCreation,void 0),l=s,d={id:(0,n.Z)(),tomeId:e,clientId:o,apply:s,revert:l};a.Q.submitMutation(i,c(d),d)}function v(e,t,i,o,s){const l=u(t,o,i,r.Kwn.WaitingForUpload,void 0),d=l,p={id:(0,n.Z)(),tomeId:e,clientId:s,apply:l,revert:d};a.Q.submitMutation(o,c(p),p,!0)}function y(e,t,i,o,s,l){const d=u(t,o,i,r.Kwn.Uploaded,void 0),g=p(t,o,null,void 0),h={id:(0,n.Z)(),tomeId:e,clientId:s,apply:d,revert:g};a.Q.submitMutation(o,c(h),h,!1,l)}},5372:function(e,t,i){i.d(t,{t:function(){return n}});const n=(0,i(4480).cn)({key:"displayAnnotationsOverlaysState",default:!0})},38176:function(e,t,i){var n=i(49312);t.Z=e=>{var t,i,o,r,a;if(!e)return!1;const s="INPUT"===(null===(t=document.activeElement)||void 0===t?void 0:t.tagName)||"TEXTAREA"===(null===(i=document.activeElement)||void 0===i?void 0:i.tagName),l="cell"===(null===(r=document.activeElement)||void 0===r||null===(o=r.children[0])||void 0===o?void 0:o.role),d=null===(a=document.activeElement)||void 0===a?void 0:a.classList.contains("slate-editor");return(0,n.V)(e.target)||l||s||d}},85361:function(e,t,i){i.d(t,{C:function(){return n},X:function(){return o}});const n=e=>{let t=!1;if(e.dataTransfer){const i=e.dataTransfer.types;for(const e in i)if("Files"===i[e]){t=!0;break}}return t};function o(e){return void 0!==e.dataTransfer}},34296:function(e,t,i){function n(e){let{src:t,width:i,quality:n}=e;const o=["auto=format","fit=max",`w=${i}`,"fm=png"];let r="";return n&&o.push(`q=${n}`),o.length&&(r=`?${o.join("&")}`),`${t}${r}`}i.d(t,{Z:function(){return n}})},64945:function(e,t,i){i.d(t,{Z:function(){return a}});var n=i(67294);class o{get(e){e:for(const[t,i]of this.map)if(t.length===e.length){for(let i=0;i<t.length;i++)if(!Object.is(t[i],e[i]))continue e;return i}}set(e,t){return this.map.set(e,t),t}constructor(){this.map=new Map}}var r=function(e){const t=new o;return function i(){for(var n=arguments.length,o=new Array(n),r=0;r<n;r++)o[r]=arguments[r];const a=t.get(o);return void 0!==a?a:o.length>=e.length?t.set(o,e.apply(this,o)):t.set(o,(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return i.apply(this,o.concat(t))}))}};var a=function(e,t){return(0,n.useMemo)((()=>r(e)),t)}}}]);
